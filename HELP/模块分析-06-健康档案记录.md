# 模块分析 06 - 健康档案记录（答辩速学稿）

聚焦健康档案（health_records）的录入、查询与权限控制：数据模型、接口流程、前端交互和实现型问答。

## 1. 快速索引（需优先阅读的文件）
- 后端： [src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)、[src/main/java/com/example/oldcaresystem/entity/HealthRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/HealthRecord.java)、[src/main/java/com/example/oldcaresystem/service/HealthRecordService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/HealthRecordService.java)、[src/main/java/com/example/oldcaresystem/mapper/HealthRecordMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/HealthRecordMapper.java)
- 数据库表： health_records 结构见 [src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)（record_type/record_date/title/details/hospital/doctor_name/attachment_url/notes 等）
- 前端： [src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)、[src/views/HealthRecordView.vue](oldcare-system-front/src/views/HealthRecordView.vue)

## 2. 数据模型与表
- health_records 字段：user_id（归属居民，兼容旧数据可能存 elderly_info.id）、record_type（checkup/diagnosis/medication/other）、record_date、title、details、hospital、doctor_name、attachment_url、notes、created_at、updated_at。
- 外键：user_id → users.id（但历史数据可能用 elderly_info.id；控制器做兼容查询）。

## 3. 后端流程与权限
- 我的记录 GET /api/health-records/my：按当前用户 userId 构造 residentIds（userId + 绑定的 elderly_info.id + 兜底按姓名匹配的老人记录），再分页查询；可选 recordType、startDate/endDate 过滤，按 record_date、created_at 倒序。
- 列表 GET /api/health-records：
  - resident：只能查看自身（同上构造 residentIds）。
  - admin/caregiver：可看全部，或按 userId 过滤（同样兼容 residentIds）。
- 详情 GET /api/health-records/{id}：resident 仅能看自己的；admin/caregiver 可看任意。
- 新增 POST /api/health-records：仅 admin/caregiver；需提供 record.userId；写 created_at/updated_at。
- 更新 PUT /api/health-records/{id}：仅 admin/caregiver；保留原 userId/created_at，更新 updated_at。
- 删除 DELETE /api/health-records/{id}：仅 admin。

## 4. 前端交互（HealthRecordView.vue）
- 角色差异：
  - resident：仅看自己的列表（调用 /my），无新增/编辑/删按钮。
  - admin/caregiver：可新增、编辑；删除仅 admin。
- 筛选：记录类型、日期范围；列表显示标题、类型 Tag、记录日期、创建时间。
- 表单：录入标题、类型、日期、医院、医生、详情、备注；校验标题/类型/日期/详情必填。

## 5. 常见问答（含“怎么实现”）
- 问：为什么 resident 查看的 user_id 还要匹配 elderly_info.id？
  - 答：旧数据可能把居民档案存 elderly_info.id，控制器通过 buildResidentIds 兼容：userId、自身关联的老人档案ID、按姓名匹配无 user_id 的老人档案。
- 问：谁能新增/编辑/删除？
  - 答：新增/编辑：admin 或 caregiver；删除：仅 admin；resident 只读。
- 问：如何过滤时间范围？
  - 答：startDate/endDate 参数走 between(record_date)；前端使用 daterange 传入 YYYY-MM-DD。
- 问：如何支持附件？
  - 答：表有 attachment_url 字段，前端可加上传组件，后端保存 URL 即可；必要时增加文件存储服务。
- 问：如何做类型扩展？
  - 答：record_type 现用 checkup/diagnosis/medication/other，可在前后端枚举中加入 blood_test、imaging 等并在查询/校验中放行。

## 6. 改进建议（答辩可提）
- 统一 ID 模型：迁移旧数据，将 user_id 全部指向 users.id，避免多重匹配。
- 数据完整性：为 user_id 建外键并使用 ON DELETE RESTRICT，防止孤儿记录；record_date 加非空约束。
- 搜索与导出：增加关键词搜索、导出 PDF/Excel；增加分页排序字段选择。
- 审计与权限细化：记录操作日志；允许居民上传自助记录但需审核通过后可见。
