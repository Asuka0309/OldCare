# 模块分析 05 - 紧急求助（答辩速学稿）

聚焦紧急求助的发起、响应、解决与权限：数据模型、接口流程、前端交互和实现型问答，方便答辩快速阐述。

## 1. 快速索引（需优先阅读的文件）
- 后端： [src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)、[src/main/java/com/example/oldcaresystem/entity/EmergencyHelp.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/EmergencyHelp.java)、[src/main/java/com/example/oldcaresystem/service/EmergencyHelpService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/EmergencyHelpService.java)、[src/main/java/com/example/oldcaresystem/mapper/EmergencyHelpMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/EmergencyHelpMapper.java)
- 数据库表： emergency_helps 定义见 [src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)（resident_id、help_type、location、status、assigned_admin_id、时间字段等）
- 前端： [src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)、[src/views/EmergencyHelpView.vue](oldcare-system-front/src/views/EmergencyHelpView.vue)

## 2. 数据模型与表
- 表 emergency_helps：
  - resident_id（求助人 users.id）、help_type（medical/fall/security/other 等）、description、location。
  - status：pending/“responding”/resolved/cancelled（表注释还含 in_progress，实际代码用 responding）。
  - assigned_admin_id 作为 responder_id（响应人用户ID），response_time/response_note/resolved_time/notified_contacts，created_time/updated_time。
- 外键：resident_id → users.id；assigned_admin_id → users.id。

## 3. 后端流程与权限
- 发起 POST /api/emergency-help：仅登录用户；设置 status=pending，写时间戳；保存后通过 NotificationService 向全部护工推送“紧急求助通知”。
- 列表 GET /api/emergency-help：管理员可查全部，可按 status 过滤，按 created_time desc。
- 我的求助 GET /api/emergency-help/my：resident_id=当前用户。
- 详情 GET /api/emergency-help/{id}：填充 responderName 便于前端展示。
- 响应 PUT /api/emergency-help/{id}/respond：管理员/护工；置 status=responding，记录 responderId=responseTime，可填 responseNote。
- 解决 PUT /api/emergency-help/{id}/resolve：管理员/护工；置 status=resolved，记录 resolved_time，可更新 responseNote。
- 取消 PUT /api/emergency-help/{id}/cancel：仅发起人；已解决不可取消。
- 删除 DELETE /api/emergency-help/{id}：仅发起人可物理删除。

## 4. 前端交互（EmergencyHelpView.vue）
- 角色视角：
  - 居民：只能看自己的求助；可发起（弹窗填写类型/内容/位置/通知联系人）、可取消、可删除。
  - 管理员/护工：看全部；可对 pending 进行“响应”，对 responding 进行“解决”。
- 列表：按状态筛选；状态 Tag 显示（待响应/已响应/已解决/已取消）；显示响应人姓名与时间（后端补充）。
- 对话框：分别用于发起、响应、解决；备注必填校验。

## 5. 常见问答（含“怎么实现”）
- 问：为何使用 status=responding 而非 in_progress？
  - 答：代码中响应后写 responding，表注释里的 in_progress 未实际使用；可统一枚举并在表注释中更新，或在控制器兼容 in_progress。
- 问：如何推送通知给护工？
  - 答：发起时调用 NotificationService.notifyAllCaregivers，通知类型 emergency_help，携带相关 ID；可扩展为按地理围栏或值班护工筛选。
- 问：谁能响应/解决？
  - 答：角色判断仅 admin 或 caregiver；设置 responderId/responseTime/resolvedTime，并写 responseNote；前端按钮同样按角色与状态显示。
- 问：如何防止非本人取消或删除？
  - 答：cancel/delete 前校验 resident_id 与当前 userId；不匹配则 403/错误提示。
- 问：如何记录完整时间线？
  - 答：已记录 created/response/resolved；可增加 in_progress 时间点或处理耗时字段，便于统计。
- 问：如何加地图定位与自动派单？
  - 答：扩展 location 存经纬度，调用地图 SDK 展示；根据地理位置选择最近护工并在 respond 接口自动填 responderId。
- 问：如何防止恶意重复求助？
  - 答：在创建时检查最近未解决的求助数量或冷却时间；可做频率限制（rate limit）。

## 6. 改进建议（答辩可提）
- 状态机：统一状态枚举 pending→responding→resolved/cancelled，接口校验合法流转，避免越级。
- 通知渠道：增加短信/微信/邮件，多通道推送；已响应/已解决也提醒发起人。
- 数据可视化：统计响应时间、解决时间，做 SLA 报表。
- 审计与安全：记录操作日志（谁响应/解决），对敏感字段做脱敏；增加求助频控。
