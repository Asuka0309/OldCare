# 模块分析 07 - 社区活动与资讯/天气（答辩速学稿）

面向答辩快速掌握社区活动、新闻资讯与天气展示：看清数据表/实体、角色与状态流转、报名限额、外部 API 代理、防 CORS 设计，以及前端仪表盘的降级策略。

## 1. 快速索引（必看文件）
- 社区活动：后端 [src/main/java/com/example/oldcaresystem/controller/CommunityActivityController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/CommunityActivityController.java)、实体 [src/main/java/com/example/oldcaresystem/entity/CommunityActivity.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/CommunityActivity.java)、报名实体/服务 [src/main/java/com/example/oldcaresystem/entity/ActivityRegistration.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/ActivityRegistration.java)、[src/main/java/com/example/oldcaresystem/service/ActivityRegistrationService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/ActivityRegistrationService.java)
- 资讯/天气代理：新闻 [src/main/java/com/example/oldcaresystem/controller/NewsController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/NewsController.java)，天气 [src/main/java/com/example/oldcaresystem/controller/WeatherController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/WeatherController.java)，资讯实体 [src/main/java/com/example/oldcaresystem/entity/CommunityNews.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/CommunityNews.java)
- 通知：后端 [src/main/java/com/example/oldcaresystem/controller/NotificationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/NotificationController.java)，实体 [src/main/java/com/example/oldcaresystem/entity/Notification.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Notification.java)
- 前端交互：活动列表/报名 [src/views/CommunityActivityView.vue](oldcare-system-front/src/views/CommunityActivityView.vue)，仪表盘展示新闻+天气+活动 [src/views/DashboardView.vue](oldcare-system-front/src/views/DashboardView.vue)，通知中心 [src/views/NotificationView.vue](oldcare-system-front/src/views/NotificationView.vue)
- 前端 API 封装：活动 [src/api/communityActivity.js](oldcare-system-front/src/api/communityActivity.js)，新闻 [src/api/news.js](oldcare-system-front/src/api/news.js)，天气 [src/api/weather.js](oldcare-system-front/src/api/weather.js)

## 2. 数据模型与表
- `community_activities`：标题、描述、类型 `lecture/fitness/entertainment/exchange/other`，时间 `activity_date`，地点，`max_participants`，`status`（draft/published/completed/cancelled），`created_time/updated_time`，`admin_id` 记录发布者；运行时附加 `currentParticipants`（非表字段）。
- `activity_registrations`：activity_id、resident_id、registration_status（registered/attended/cancelled），创建/更新时间；用于计数与防重复报名。
- `community_news`：admin_id、title/content、category（policy/health/news）、cover_image、status（draft/published/archived）、view_count、创建/更新时间。（当前后端未提供 CRUD，资讯通过外部新闻 API 代理获取。）
- `notifications`：receiver_id、sender_id、notification_type（emergency_help/appointment/evaluation）、title、content、related_id、is_read、created_at/read_at。

## 3. 后端接口与业务流程
- 活动列表 GET /api/activities：支持 page/size/status/type/keyword；非管理员默认只看 status=published；管理员可按传入 status 过滤。返回页数据后为每条计算当前报名人数（countByActivityId）。
- 活动详情 GET /api/activities/{id}：返回单条并填充 currentParticipants。
- 发布活动 POST /api/activities：写入 organizerId=当前用户、status=published、创建/更新时间；无角色校验，需在网关或切面控制仅管理员可发。
- 更新活动 PUT /api/activities/{id}：直接 updateById，更新时间；无字段级校验。
- 取消活动 PUT /api/activities/{id}/cancel：仅 ADMIN，completed 状态不可取消，改 status=cancelled。
- 删除活动 DELETE /api/activities/{id}：仅 ADMIN，物理删除。
- 标记完成 PUT /api/activities/{id}/complete：无角色限制（应限制 ADMIN），改 status=completed。
- 报名 POST /api/activities/{id}/register：仅已发布活动可报；防重复（isRegistered），人数满时拒绝；插入 registration_status=registered。
- 取消报名 DELETE /api/activities/{id}/register：按 activity_id + resident_id + registration_status=registered 查记录，置为 cancelled。
- 新闻代理 GET /api/news：将请求转发到聚合数据 API（news.api.url/key 配置）；组装查询参数、解码响应；非 200 时返回错误信息。
- 天气代理 GET /api/weather：内部 POST 调用天行数据 API（key/URL硬编码）；城市参数默认北京；返回 JSON 直接透传。
- 通知：GET /api/notifications（全部）、GET /api/notifications/unread（未读）、PUT /api/notifications/{id}/read 标记已读。使用 UserContext 获取当前用户。

## 4. 前端交互与流程
- 活动页：筛选 status/type/keyword，分页；管理员可新增/编辑/完成/取消/删除；居民可报名/取消报名。`currentParticipants` 展示已报名数，报名后刷新。日期用 `toLocaleDateString`，时间 `toLocaleString`。
- 仪表盘：加载天气（调用 /api/weather，解析新旧格式，失败时回退模拟数据）、新闻（调用 /api/news，兼容多种字段名，失败时回退 8 条模拟数据）、活动（取 status=published，过滤日期>=今日，显示前 8 条）。定时刷新时间显示。
- 通知页：拉取全部通知（若失败则拉取未读），支持标记单条/全部已读，30 秒轮询刷新；简单搜索标题/内容。

## 5. 角色与权限要点
- 活动读取：非管理员只能看到 published；管理员可按 status 过滤。
- 活动写操作（发布/编辑/取消/删除/完成）：代码仅在取消时校验 ADMIN，其余需补充角色校验。
- 报名接口默认居民使用，无额外角色判定；可按需求限制只有居民角色可报。
- 通知接口基于登录用户 id 过滤，未区分角色；通知类型区分业务来源。

## 6. 答辩常见问答（含实现思路）
- 问：如何防止活动超额报名？
  - 答：报名时先 countByActivityId，再与 maxParticipants 比较；若超额返回“报名人数已满”；同时用 isRegistered 防重复提交。
- 问：为什么普通用户看不到草稿/取消的活动？
  - 答：列表对非管理员强制 status=published，避免未发布或取消活动暴露；只有管理员可切换状态或查看其他状态。
- 问：如果活动已完成还能取消吗？
  - 答：取消接口阻止对 completed 状态操作；业务上可拓展“已完成不可再报名/编辑”校验。
- 问：新闻/天气如何绕过浏览器 CORS？
  - 答：前端请求后端 `/api/news`、`/api/weather`，后端再请求外部 API 并返回 JSON，实现同源代理避免前端直接跨域。
- 问：外部 API 挂了怎么办？
  - 答：前端 Dashboard 对新闻/天气有回退：捕获异常后填充模拟数据，保障页面可用性；同时日志提示检查 `news.api.url/key` 配置或网络。
- 问：通知如何变已读？
  - 答：PUT /api/notifications/{id}/read 将 is_read 置 true、记录 read_at；前端标记后本地也改状态，无需刷新。

## 7. 改进建议（可用于答辩加分）
- 权限与校验：对发布/更新/完成接口补充角色校验与必填字段校验；报名/取消报名的幂等性可加唯一索引 (activity_id,resident_id,registration_status)。
- 状态流转：统一状态机（draft→published→completed/ cancelled），限制非法跳转；活动取消/删除前提示并批量取消报名。
- 外部 API 配置安全：天气 API key 现硬编码，建议改为配置文件/环境变量；对新闻/天气增加超时重试与限流。
- 性能与可用性：活动列表 currentParticipants 每条查询可改为聚合 SQL（COUNT GROUP BY）；新闻/天气结果可短时缓存，减少外部调用。
- 资讯本地化：如需自建社区资讯，可为 CommunityNews 增加 CRUD（发布/审核/归档）、浏览量累加，并在前端列表展示。
- 通知增强：支持已读批量接口、分页、按类型筛选；与活动/预约联动推送（如报名成功或活动取消时通知）。
