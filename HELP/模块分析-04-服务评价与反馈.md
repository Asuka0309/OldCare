# 模块分析 04 - 服务评价与反馈（答辩速学稿）

覆盖服务评价（含投诉）与反馈建议：数据模型、接口流程、角色可见性、前端表单与列表，以及实现型问答。

## 1. 快速索引（需优先阅读的文件）
- 评价模块： [src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)、[src/main/java/com/example/oldcaresystem/service/EvaluationService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/EvaluationService.java)、[src/main/java/com/example/oldcaresystem/entity/Evaluation.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Evaluation.java)
- 反馈模块： [src/main/java/com/example/oldcaresystem/controller/FeedbackController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeedbackController.java)、[src/main/java/com/example/oldcaresystem/service/FeedbackService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/FeedbackService.java)、[src/main/java/com/example/oldcaresystem/entity/Feedback.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Feedback.java)
- 数据库表： evaluations、feedbacks（字段与外键见 [src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)）
- 前端交互： [src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)、[src/api/feedback.js](oldcare-system-front/src/api/feedback.js)、[src/views/EvaluationView.vue](oldcare-system-front/src/views/EvaluationView.vue)、[src/views/FeedbackView.vue](oldcare-system-front/src/views/FeedbackView.vue)

## 2. 数据模型与表
- evaluations：appointment_id、resident_id（users.id 或旧数据 elderly_info.id）、provider_id（caregivers.id）、评分项（service_quality/attitude/effect/overall）、comment、is_complaint、complaint_reason、status（已评价/已回复/已解决）、created_time、updated_time。
- feedbacks：user_id、role（resident/caregiver）、title、category（suggestion/issue/complaint/general）、content、status（pending/processing/resolved）、handler_id、remark、created_time、updated_time；非持久化 userName、handlerName 用于展示。

## 3. 服务评价流程（后端）
- 新增 POST /api/evaluation：仅居民；必填 appointmentId/overallRating/comment；校验预约存在且状态已完成、预约归当前居民。providerId 通过预约的 caregiverId 反查 caregivers.id 绑定；状态设已评价，写时间戳保存。
- 更新 PUT /api/evaluation/{id}：仅居民可改自己的评价；更新 updated_time。
- 删除 DELETE /api/evaluation/{id}：居民可删自己的，管理员可删任意，护工不可删；旧数据 resident_id 可能指 elderly_info.id，控制器兼容检查。
- 查询 GET /api/evaluation：分页；
  - caregiver 仅看 provider_id=自己（按 user_id 查 caregiver.id）；
  - resident 仅看自己（兼容 resident_id 为 user_id 或 elderly_info.id）；
  - admin 全部；
  - 可按 appointmentId、providerId、isComplaint 过滤，按 created_time desc。
- 投诉 GET /api/evaluation/complaints：is_complaint=true；护工只看自己的投诉，admin/resident 可看全部。

## 4. 反馈建议流程（后端）
- 提交 POST /api/feedback：居民/护工可提交；校验标题/内容；写 userId/role/status=pending/time 置入。
- 我的反馈 GET /api/feedback/my：按 user_id 过滤，支持 status，按 created_time desc。
- 管理员列表 GET /api/feedback：admin 仅；可按 status/category/role 过滤。
- 单条 GET /api/feedback/{id}：admin 任意查看；非 admin 只能看自己的。
- 处理 PUT /api/feedback/{id}/resolve：仅 admin；更新 status（processing/resolved）、remark、handlerId、更新时间。

## 5. 前端交互
- EvaluationView：
  - 居民新增/编辑评价（选择已完成预约，评分/文字、是否投诉）。
  - 列表筛选：预约、仅投诉；按钮：居民可编删，管理员可删，护工不可删。
  - 显示评分星级、投诉标记、状态；过滤预约仅当前居民。
- FeedbackView：
  - 居民/护工/Admin 可提交反馈（标题/类别/内容）。
  - 管理员可按状态/类别/角色筛选并处理（修改状态与备注）。
  - 非 admin 仅查看自己的；admin 显示提交人及角色。

## 6. 关联与约束
- evaluations.appointment_id → appointments.id；provider_id → caregivers.id；resident_id 指向用户或旧的 elderly_info.id（控制器已兼容）。
- 仅已完成预约可评价；完成预约时已生成 fee_record，评价不再写费用。
- feedbacks.handler_id → users.id（可空，处理时写入）。

## 7. 答辩常见问答（含“怎么实现”）
- 问：为什么只允许已完成的预约被评价？
  - 答：确保服务体验已闭环，避免对未完成服务的提前评分；控制器在 add 中校验 status=已完成。
- 问：护工看到哪些评价？
  - 答：list 时若 role=caregiver，用 userId 反查 caregivers.id，并以 provider_id 过滤，只看到给自己的评价/投诉。
- 问：居民如何被限制只能评价自己的预约？
  - 答：add 校验 appointment.residentId 与当前 userId 相等（兼容旧数据）；不匹配则 403。
- 问：投诉与普通评价有何差异？
  - 答：评价表有 is_complaint 与 complaint_reason；前端“仅投诉”过滤，后端有 /complaints 专门出口。
- 问：怎么处理反馈的工作流？
  - 答：提交后 status=pending；管理员在 /feedback/{id}/resolve 将状态改 processing/resolved 并写 remark、handlerId、更新时间；列表按状态筛选。
- 问：如何防止非管理员读取他人反馈？
  - 答：详情接口若非 admin 必须 user_id 匹配当前用户，否则 403；列表接口 admin 才能查全量，居民/护工只能 /feedback/my。
- 问：如果要允许服务提供商回复评价怎么做？
  - 答：在 evaluations 增加 reply_content/reply_time/replier_id；提供 PUT /evaluation/{id}/reply 仅管理员或该 provider 可调用；status 改已回复。
- 问：评分标准如何约束？
  - 答：后端可校验评分 1–5（含半星则用 0.5 步长）；前端 el-rate 已支持半星，新增 rules 校验数值范围。
- 问：如何统计满意度或投诉率？
  - 答：在查询层加聚合：overallRating 平均、is_complaint 比例；或在 statistics 表存每日汇总，定时任务写入。

## 8. 改进建议（可作答辩补充）
- 数据一致性：评分写入时幂等检查，避免重复评价同一预约；可在 evaluations 添加唯一索引 (appointment_id, resident_id)。
- 状态机：feedback status/ evaluation status 定义有限状态迁移，接口按状态校验，避免越级操作。
- 通知：投诉/反馈处理完成后发送站内信/邮件给提交人。
- 隐私与脱敏：列表展示时隐藏联系方式；日志记录操作人。
- 质量指标：增加标签/图片上传，支持多维度统计报表。
