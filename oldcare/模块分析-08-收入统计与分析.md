# 收入统计与分析模块 - 详细分析

## 📌 模块概述

**模块名称**：收入统计与分析（Income Statistics）  
**核心功能**：按周期统计收入总额与交易笔数，绘制趋势图，支持管理员与护工视角  
**适用角色**：管理员（全局统计）、护工（个人收入统计）  
**关键特性**：按周期聚合（今天/最近一周/本月/本年）、仅纳入已支付费用、日期补零填充趋势、前端 ECharts 折线图展示

---

## 🎯 核心功能

### 1. 周期收入统计
- 支持 `today/week/month/year` 四种周期选择。
- 统计维度：
  - 总收入（`totalAmount`，BigDecimal 累加）
  - 交易笔数（`totalCount`，记录条数）
  - 时间范围（`startDate` ~ `endDate`）
  - 趋势数据（`chartData[ {date, amount} ]`）
- 仅统计状态为“已支付”的费用，时间以 `payment_time` 为准。

### 2. 角色视角
- 管理员：全局统计（所有已支付费用）。
- 护工：个人统计（按当前登录护工的完成预约→对应费用记录）。
- 居民：不开放访问收入统计接口（返回 403）。

### 3. 趋势图与日期补零
- 后端生成从 `startDate` 到 `today` 的逐日数据点，未发生收入的日期补零，确保前端折线图连续展示。
- 前端对金额格式化为两位小数，并以“¥”展示。

### 4. 数据来源与过滤
- 数据来源：`fee_records`（已支付）、`appointments`（护工过滤）、`caregivers`（用户→护工映射）。
- 过滤逻辑：
  - 管理员：`status=已支付` 且 `payment_time` 落入周期。
  - 护工：定位当前护工 → 找出其 `provider_id` 的已完成预约 → 以这些预约的 `appointment_id` 过滤 `fee_records` → 同样限定 `status=已支付` 与 `payment_time` 周期。

---

## 📡 API 接口

### 1. 收入统计
```
GET /api/income/statistics
参数：period ∈ {today, week, month, year}（可选，默认 month）
角色：admin | caregiver（resident 禁止）
```

**请求示例：**
```
GET /api/income/statistics?period=month
Authorization: Bearer <JWT>
```

**成功响应（管理员示例）：**
```
{
  "code": 0,
  "message": "操作成功",
  "data": {
    "totalAmount": 1250.00,
    "totalCount": 37,
    "period": "month",
    "startDate": "2025-12-01",
    "endDate": "2025-12-28",
    "chartData": [
      {"date": "2025-12-01", "amount": 50.00},
      {"date": "2025-12-02", "amount": 0.00},
      ...
    ],
    "role": "admin"
  }
}
```

**失败响应（居民访问）：**
```
{
  "code": 403,
  "message": "无权限查看收入统计",
  "data": null
}
```

### 2. 权限与校验逻辑（后端实现要点）
- 获取当前用户 `role` / `userId`（`UserContext`）。
- 非 `admin` 与 `caregiver` 直接返回 403。
- 护工统计：
  - 通过 `caregivers.user_id = userId` 找到护工实体。
  - 查询 `appointments.provider_id = caregiver.id AND status = '已完成'`。
  - 取这些预约的 `appointment_id` 作为过滤条件查询费用记录。
- 费用记录筛选条件：`status = '已支付'` 且 `payment_time ∈ [startDateTime, now]`。

---

## 🎨 前端页面

### 1. 页面：IncomeView.vue（收入统计）
- 周期选择下拉框：今天/最近一周/本月/本年（默认“本月”）。
- 统计卡片：总收入、交易笔数、统计周期文本。
- 趋势图：基于 ECharts 折线图，标题根据角色显示“总收入趋势”或“我的收入趋势”。
- 加载状态与空数据提示：`loading` / `暂无数据`。

**关键交互与方法：**
- `getIncomeStatistics(period)`：从 `src/api/income.js` 调用接口。
- `formatAmount()`：金额两位小数格式化。
- `getPeriodText()`：周期中文映射。
- `chartOption`：
  - X 轴：日期（从后端 `chartData.date` 转为 `MM/DD`）。
  - Y 轴：金额（`¥` + 两位小数）。
  - 折线：平滑，带渐变面积，颜色黑灰系。

**权限适配：**
- 通过 `authStore.user.role` 判断 `isAdmin/isCaregiver`，动态设置图表标题与系列名称。
- 居民不会进入此页（路由守卫 + 接口权限）。

### 2. API 封装：src/api/income.js
```
export function getIncomeStatistics(period) {
  return http.get('income/statistics', { params: { period } })
}
```

---

## 🗄️ 数据模型

### 1. 费用记录表：fee_records
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 费用记录ID |
| appointment_id | BIGINT | 关联预约ID |
| resident_id | BIGINT | 居民ID（兼容旧数据 elderly_id） |
| service_name | VARCHAR | 服务名称（冗余便于展示） |
| amount | DECIMAL(10,2) | 金额 |
| fee_type | VARCHAR | 费用类型（service/materials/other） |
| status | VARCHAR | 支付状态：未支付/已支付/退款申请中/已退款 |
| due_date | DATE | 应付日期 |
| payment_time | DATETIME | 支付时间（统计时间维度） |
| refund_time | DATETIME | 退款时间 |
| remark | VARCHAR | 备注 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

### 2. 预约表：appointments（统计过滤用）
| 关键字段 | 说明 |
|----------|------|
| id | 预约ID |
| provider_id | 护工ID（Caregiver.id） |
| status | 预约状态（统计仅纳入“已完成”） |

### 3. 护工表：caregivers（用户映射）
| 关键字段 | 说明 |
|----------|------|
| id | 护工ID（与 appointments.provider_id 对应） |
| user_id | 用户ID（当前登录护工的 userId） |

### 4. 索引建议
- `fee_records(status, payment_time)` 复合索引：提升周期筛选性能。
- `appointments(provider_id, status)` 复合索引：提升护工完成预约筛选性能。
- `fee_records(appointment_id)`：便于通过预约过滤费用记录。

---

## 🔄 业务流程

### 1. 周期统计通用流程
```
选择周期（today/week/month/year）
    ↓
后端解析周期起点（startDate）并构造 [startDate, now]
    ↓
按角色过滤费用记录：
  - 管理员：所有已支付费用（payment_time 在范围内）
  - 护工：定位护工 → 已完成预约 → 对应费用（同样限定 payment_time 在范围内）
    ↓
累加 totalAmount（BigDecimal）、计算 totalCount（条数）
    ↓
按日聚合，补零生成 chartData
    ↓
返回结果给前端
```

### 2. 护工收入统计细节
- 护工端不直接基于 `fee_records` 的 `provider_id`（该字段不在费用表中），而是通过预约表关联过滤：
  - 找到当前用户对应的护工记录。
  - 获取该护工的所有“已完成”预约ID集合。
  - 用该集合过滤费用记录，再限定“已支付”与时间范围。

### 3. 退款与状态影响
- “退款申请中”与“已退款”均不计入收入统计（仅纳入“已支付”）。
- 如果先支付后退款，原“已支付”记录在统计周期内不应计入当前收入，可考虑：
  - 现状：`IncomeController` 不回填负数抵消，直接排除“已退款”。
  - 建议：在财务精确口径下，增加“净收入”口径（`已支付 - 已退款`），或引入冲销记录。

---

## 🔐 权限与角色

| 功能 | admin | caregiver | resident |
|------|-------|-----------|----------|
| 查看收入统计 | ✅ | ✅（仅个人） | ❌ |
| 切换统计周期 | ✅ | ✅ | ❌ |
| 趋势图展示 | ✅ | ✅ | ❌ |

**后端强校验：** 非 `admin` 或 `caregiver` 直接返回 403。  
**前端路由守卫：** 居民不展示收入统计菜单项，不可访问页面。

---

## 📏 数据准确性与边界条件

- 周期起点：
  - `today`：当天开始；
  - `week`：`LocalDate.now().minusWeeks(1)`（最近 7 天）；
  - `month`：当月第一天；
  - `year`：当年第一天。
- 时间维度：以 `payment_time` 为准，使用服务器本地时间（注意时区一致性）。
- 空数据：护工未完成预约或无已支付费用时，返回空统计（`totalAmount=0, totalCount=0, chartData=[]`）。
- 金额类型：后端为 `BigDecimal`，前端统一转 `Number` 并两位小数展示。
- 日期补零：后端逐日生成，确保趋势连续；前端将 `YYYY-MM-DD` 转成 `MM/DD` 文本。
- 数据兼容：费用表存在 `elderlyId` 兼容字段，统计逻辑不依赖该字段，仅依赖 `appointment_id`。

---

## ⚠️ 已知问题与优化建议

1. 护工统计效率问题  
   - 现状：通过“护工→预约ID集合→费用记录 in (IDs)”两次查询过滤。  
   - 建议：
     - 在 `fee_records` 冗余 `provider_id` 字段，直接按护工过滤；
     - 或使用数据库视图/联表查询减少中间集合与内存处理。

2. 退款口径与净收入  
   - 现状：只统计“已支付”，不负向冲销退款。  
   - 建议：
     - 增加“净收入”统计（已支付减去已退款），并新增曲线对比；
     - 同步考虑“退款申请中”的展示与提示。

3. 时区与跨日边界  
   - 现状：以服务器本地时间计算。  
   - 建议：
     - 明确统一的时区配置；
     - 对于跨日支付在边界的记录，确保入库与统计的时区一致。

4. 维度扩展不足  
   - 建议：增加维度与端点：
     - 按服务类型（`service_name`/`service_id`）统计；
     - 按护工排名（Top-N）与贡献度；
     - 按居民群体、社区分区统计；
     - 月/季/年对比与环比、同比。

5. 前端图表增强  
   - 建议：
     - 增加滚动缩放、数据标注、阈值线；
     - 支持柱状图/面积图切换；
     - 导出图片与 CSV 数据。

6. 缓存与性能  
   - 建议：
     - 周期统计结果短期缓存（如 5 分钟）减少热区请求压力；
     - 管理员全局统计适合做离线预聚合与定时任务刷新。

---

## 🧪 测试场景

### 1. 管理员视角
- 场景1：本月有多笔“已支付”费用，`chartData` 连续补零正确，总额与笔数与数据库一致。
- 场景2：最近一周无支付，返回 `totalAmount=0, totalCount=0, chartData=[]`。
- 场景3：包含退款记录，确认未计入总收入，并验证“净收入”扩展口径（如已实现）。

### 2. 护工视角
- 场景4：护工存在“已完成”预约与对应“已支付”费用，曲线与条目正确。
- 场景5：护工无任何“已完成”预约，返回空统计。
- 场景6：护工存在已完成但未支付费用，确认不计入统计。

### 3. 权限与边界
- 场景7：居民访问接口返回 403。
- 场景8：`period` 为空，默认按“本月”统计。
- 场景9：`period` 非法值，后端回退到“本月”。

### 4. 数据正确性
- 场景10：支付时间在周期边界（起始日 00:00:00 与当前时刻），包含/排除正确。
- 场景11：chartData 每日金额与 `fee_records` 按日聚合一致。

---

## 🔌 模块集成

- 与费用管理（FeeRecord）：作为数据源与口径控制（支付/退款）。
- 与预约管理（Appointment）：护工过滤所需的完成预约集合。
- 与角色/权限：前后端一致阻止居民访问；菜单显示受角色控制。
- 与通知/报表（扩展）：达到阈值时触发通知；导出报表用于运营分析。

---

## 📈 扩展接口设计建议（可选）

- `GET /api/income/by-service`：按服务类型聚合收入（支持周期与 Top-N）。
- `GET /api/income/by-caregiver`：按护工聚合与排名（支持分页）。
- `GET /api/income/daily`：返回指定周期内每日的净收入/总收入双曲线数据。
- `GET /api/income/compare`：环比/同比对比接口，返回多周期对比数据。

---

## 总结

收入统计与分析模块围绕“已支付费用”的周期性聚合，清晰区分管理员与护工视角：
- ✅ 周期统计与趋势图展示完整可靠；
- ✅ 权限控制严格（仅 admin/caregiver）；
- ✅ 护工统计通过预约过滤确保准确归属；
- ✅ 日期补零使可视化连续直观。

优先改进方向：
- ① 退款口径引入“净收入”与冲销模型；
- ② 维度扩展（服务、护工、居民群体、区域）；
- ③ 性能与缓存（预聚合/短期缓存）；
- ④ 前端图表交互增强与导出能力。
