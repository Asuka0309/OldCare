# 紧急求助模块 - 前后端文件映射清单

> 本清单以“紧急求助发起/查询/响应/解决/取消/删除 + 通知联动”作为联调主线，按“前端页面/前端 API/后端接口入口/关键业务逻辑/数据库表结构”整理。

---

## 前端文件（Vue 3 + Vite）

- 紧急求助页面（列表/筛选/发起/查看/响应/解决/取消/删除）：
  - [oldcare-system-front/src/views/EmergencyHelpView.vue](oldcare-system-front/src/views/EmergencyHelpView.vue)

- 紧急求助 API 封装：
  - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)

### 通用依赖（鉴权与路由）

- HTTP baseURL & Token 注入（`baseURL=/api`）：
  - [oldcare-system-front/src/api/http.js](oldcare-system-front/src/api/http.js)
- 登录态（sessionStorage）：
  - [oldcare-system-front/src/store/auth.js](oldcare-system-front/src/store/auth.js)
- 路由（包含 `'/emergency-help'`）：
  - [oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js)

---

## 后端文件（Spring Boot + MyBatis-Plus）

- 紧急求助接口入口（REST Controller）：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 紧急求助领域对象（实体，映射 `emergency_helps`）：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/entity/EmergencyHelp.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/EmergencyHelp.java)

- Service：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/service/EmergencyHelpService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/EmergencyHelpService.java)
  - [oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/EmergencyHelpServiceImpl.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/EmergencyHelpServiceImpl.java)

- Mapper：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/mapper/EmergencyHelpMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/EmergencyHelpMapper.java)

### 通知联动（紧急求助触发通知 / 通知被阅读后可自动响应）

- 通知服务接口与实现：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/service/NotificationService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/NotificationService.java)
  - [oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/NotificationServiceImpl.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/NotificationServiceImpl.java)

### 鉴权与用户上下文

- 获取当前 userId/role：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java](oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java)
- 安全规则：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java](oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java)

---

## 接口清单（路径映射）

> 前端 `http.js` 的 `baseURL` 是 `/api`。

### 1) 查询

- 获取所有求助（当前后端未做角色强校验）：
  - `GET /api/emergency-help?page=1&size=10&status=`
  - 前端调用：`getAllEmergencyHelps(params)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@GetMapping`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 获取我的求助：
  - `GET /api/emergency-help/my?page=1&size=10`
  - 前端调用：`getMyEmergencyHelps(params)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@GetMapping("/my")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 获取详情：
  - `GET /api/emergency-help/{id}`
  - 前端调用：`getEmergencyHelpById(id)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@GetMapping("/{id}")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

### 2) 操作

- 发起求助（当前登录用户作为发起人）：
  - `POST /api/emergency-help`
  - 前端调用：`createEmergencyHelp(data)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@PostMapping`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 响应求助（管理员/护工）：
  - `PUT /api/emergency-help/{id}/respond`
  - 前端调用：`respondEmergencyHelp(id, data)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@PutMapping("/{id}/respond")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 解决求助（管理员/护工）：
  - `PUT /api/emergency-help/{id}/resolve`
  - 前端调用：`resolveEmergencyHelp(id, data)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@PutMapping("/{id}/resolve")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 取消求助（仅发起人）：
  - `PUT /api/emergency-help/{id}/cancel`
  - 前端调用：`cancelEmergencyHelp(id)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@PutMapping("/{id}/cancel")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 删除求助（物理删除，仅发起人）：
  - `DELETE /api/emergency-help/{id}`
  - 前端调用：`deleteEmergencyHelp(id)`
    - [oldcare-system-front/src/api/emergencyHelp.js](oldcare-system-front/src/api/emergencyHelp.js)
  - 后端入口：`@DeleteMapping("/{id}")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

---

## 关键逻辑位置（状态机/权限/通知）

- 发起求助的初始化：
  - 设置发起人 `userId`、状态 `pending`、创建/更新时间
  - 保存成功后调用 `notificationService.notifyAllCaregivers(...)`
  - 入口：
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 响应/解决权限：
  - 后端在 `respond/resolve` 中校验 `role in {admin, caregiver}`
  - 入口：
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 取消/删除权限：
  - 后端校验“仅发起人可取消/删除”；且已解决不可取消
  - 入口：
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EmergencyHelpController.java)

- 通知与自动响应联动：
  - `NotificationServiceImpl.markAsRead(...)`：当护工/管理员阅读紧急求助通知时，如果对应求助还处于 `pending`，会自动更新为 `responding` 并写入 responderId/responseTime
  - 入口：
    - [oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/NotificationServiceImpl.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/NotificationServiceImpl.java)

---

## 数据库表

- SQL 脚本（包含 `emergency_helps` 表结构）：
  - [oldcare-system/src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)

---

## 备注（联调常见点 / 与分析文档差异）

- 路由权限与页面逻辑存在不一致：
  - 页面 [oldcare-system-front/src/views/EmergencyHelpView.vue](oldcare-system-front/src/views/EmergencyHelpView.vue) 支持 `admin/caregiver` 的“响应/解决”按钮逻辑；
  - 但路由 [oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js) 对 `'/emergency-help'` 配置了 `meta.roles: ['resident']`，导致管理员/护工无法进入该页面。

- 状态枚举存在历史兼容：
  - 代码实际使用：`pending / responding / resolved / cancelled`（Controller + 前端）；
  - SQL 注释里写的是 `pending / in_progress / resolved`，且示例数据里也出现 `responding`。

- “全部列表”接口未做角色强制：
  - 后端 `GET /api/emergency-help` 目前没有显式限制 admin 才能访问；是否需要限制取决于业务要求（现状主要依赖前端路由与页面入口控制）。
