# 健康档案模块 - 前后端文件映射清单

> 本清单覆盖“健康记录（health-records）”的列表/筛选/查看/新增/编辑/删除，以及按角色（admin/caregiver/resident）数据隔离与权限控制。

---

## 前端文件（Vue 3 + Vite）

- 健康记录页面（列表/筛选/查看/新增/编辑/删除）：
  - [oldcare-system-front/src/views/HealthRecordView.vue](oldcare-system-front/src/views/HealthRecordView.vue)

- 健康记录 API 封装：
  - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)

### 菜单与路由

- 菜单入口（不同角色都展示“健康记录”）：
  - [oldcare-system-front/src/views/LayoutShell.vue](oldcare-system-front/src/views/LayoutShell.vue)

- 路由配置（`/health-records`，角色：admin/resident/caregiver）：
  - [oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js)

### 通用依赖（鉴权）

- HTTP baseURL & Token 注入（`baseURL=/api`）：
  - [oldcare-system-front/src/api/http.js](oldcare-system-front/src/api/http.js)
- 登录态（sessionStorage）：
  - [oldcare-system-front/src/store/auth.js](oldcare-system-front/src/store/auth.js)

---

## 后端文件（Spring Boot + MyBatis-Plus）

- 健康档案接口入口：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

- 实体（映射 `health_records`）：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/entity/HealthRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/HealthRecord.java)

- Service：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/service/HealthRecordService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/HealthRecordService.java)
  - [oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/HealthRecordServiceImpl.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/HealthRecordServiceImpl.java)

- Mapper：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/mapper/HealthRecordMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/HealthRecordMapper.java)

### 鉴权与用户上下文

- 获取当前 userId/role：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java](oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java)
- 安全规则：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java](oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java)

---

## 接口清单（路径映射）

> 前端 `http.js` 的 `baseURL` 是 `/api`。

### 1) 查询

- 获取我的健康档案（resident 常用）：
  - `GET /api/health-records/my?page=1&size=10&recordType=&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
  - 前端：`getMyHealthRecords(params)`
    - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)
  - 后端：`@GetMapping("/my")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

- 获取健康档案分页列表（admin/caregiver 常用；resident 会被后端强制过滤为只看自己）：
  - `GET /api/health-records?page=1&size=10&userId=&recordType=&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
  - 前端：`getAllHealthRecords(params)`
    - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)
  - 后端：`@GetMapping`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

- 获取详情（resident 仅可看自己的；admin/caregiver 可看所有）：
  - `GET /api/health-records/{id}`
  - 前端：`getHealthRecordById(id)`（当前页面查看直接使用 row 数据展示，未强依赖该接口）
    - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)
  - 后端：`@GetMapping("/{id}")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

### 2) 操作

- 新增（仅 admin/caregiver）：
  - `POST /api/health-records`
  - 前端：`createHealthRecord(data)`
    - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)
  - 后端：`@PostMapping`（resident 直接拒绝）
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

- 更新（仅 admin/caregiver）：
  - `PUT /api/health-records/{id}`
  - 前端：`updateHealthRecord(id, data)`
    - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)
  - 后端：`@PutMapping("/{id}")`（会强制保持 userId/createdAt 不变，仅更新 updatedAt）
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

- 删除（仅 admin）：
  - `DELETE /api/health-records/{id}`
  - 前端：`deleteHealthRecord(id)`（页面也做了“仅管理员可删除”按钮控制）
    - [oldcare-system-front/src/api/healthRecord.js](oldcare-system-front/src/api/healthRecord.js)
  - 后端：`@DeleteMapping("/{id}")`
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

---

## 关键逻辑位置（权限/数据隔离/筛选）

- 角色权限：
  - resident：只能查询自己的、查看自己的；新增/编辑/删除均禁止
  - caregiver：可新增/编辑；可查看所有（分页列表接口）
  - admin：可新增/编辑/删除；可查看所有
  - 入口：
    - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/HealthRecordController.java)

- 数据隔离（resident）：
  - `GET /api/health-records`：resident 即使传 `userId` 也会被强制 `user_id=currentUserId`
  - `GET /api/health-records/{id}`：resident 校验 `record.userId == currentUserId`

- 时间范围筛选：
  - 后端 `between(record_date, startDate, endDate)` 仅在“startDate 和 endDate 同时存在”时才生效
  - 前端当选择日期区间时会一次性传两者

---

## 数据库表

- 实体映射表名：`health_records`
  - 参考：
    - [oldcare-system/src/main/java/com/example/oldcaresystem/entity/HealthRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/HealthRecord.java)

- 备注：当前提供的 SQL dump [oldcare-system/src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql) 中未包含 `health_records` 的建表语句（可能在其他迁移脚本或后续版本中创建）。

---

## 备注（联调常见点）

- `recordType` 值是字符串：前端使用 `checkup/medication/treatment/other`；后端实体注释中出现 `diagnosis`，但代码未做枚举校验，实际以数据库存入值为准。
- 前端“查看详情”弹窗直接展示列表行数据（未二次请求详情接口），如果后续需要展示更完整字段（如 `doctorName/attachmentUrl`），可以考虑在 `handleView` 时调用 `getHealthRecordById`。
