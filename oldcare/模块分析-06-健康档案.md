# 健康档案模块 - 详细分析

## 📌 模块概述

**模块名称**：健康档案  
**核心功能**：记录和管理老人的健康检查记录、诊疗记录、用药记录等  
**适用角色**：管理员（创建/编辑/删除）、护工（创建/编辑）、居民（查看）  
**关键特性**：多类型记录、时间范围查询、权限隔离、历史追踪  
**优先级**：⭐⭐⭐ 老人健康管理的基础

---

## 🎯 核心概念

### 1. 健康档案定义

健康档案是**对老人健康状况的记录和存档**，包括体检、诊疗、用药等各类医疗信息。

```
健康档案 = 老人 + 记录类型 + 记录日期 + 医疗内容 + 医生/医院 + 附件
```

**实体字段**：
```java
HealthRecord {
  id                    // 记录ID
  userId                // 关联的老人ID（用户ID）
  
  // 记录信息
  recordType            // 记录类型（checkup/medication/treatment/other）
  title                 // 记录标题（如"2025年体检报告"）
  details               // 记录详情内容
  recordDate            // 记录日期（体检/诊疗发生的日期）
  
  // 医疗信息
  hospital              // 医院/诊所名称
  doctorName            // 医生姓名
  attachmentUrl         // 附件URL（如体检报告图片/PDF）
  
  // 额外信息
  notes                 // 其他备注
  
  // 时间戳
  createdAt             // 创建时间
  updatedAt             // 更新时间
}
```

### 2. 记录类型

| 类型 | 说明 | 典型内容 | 举例 |
|------|------|--------|------|
| **checkup** | 检查报告 | 体检、检验结果 | 2025年度体检、血液检验报告 |
| **medication** | 用药记录 | 处方药、长期用药 | 每日服用高血压药、糖尿病用药 |
| **treatment** | 诊疗记录 | 医生诊疗、手术记录 | 门诊就诊、腰椎手术 |
| **other** | 其他 | 其他医疗信息 | 防疫接种、健康咨询 |

### 3. 健康档案生命周期

```
【创建】
  管理员或护工输入健康信息
  └─ 记录类型、日期、内容、医生、医院等

【保存】
  系统自动记录创建时间
  └─ 与老人的用户ID关联

【查看】
  ├─ 老人：查看自己的全部健康档案
  ├─ 护工：查看所有老人的档案
  └─ 管理员：查看和管理所有档案

【编辑】
  管理员和护工可以修改记录内容
  └─ 自动更新修改时间

【删除】
  仅管理员可以删除（需谨慎，涉及医疗历史）

【导出/分享】
  （当前未实现，但是重要功能）
```

---

## 📡 API 接口

### 1. 查询接口

#### 1.1 获取我的健康档案
```
GET /api/health-records/my?page=1&size=10&recordType=checkup&startDate=2025-01-01&endDate=2025-12-31
参数：
  - page: 当前页码（默认1）
  - size: 每页条数（默认10）
  - recordType: 按类型筛选（checkup/medication/treatment/other，可选）
  - startDate: 开始日期，YYYY-MM-DD格式（可选）
  - endDate: 结束日期，YYYY-MM-DD格式（可选）

响应：{
  "code": 0,
  "message": "成功",
  "data": {
    "records": [
      {
        "id": 1,
        "userId": 123,
        "recordType": "checkup",
        "title": "2025年度体检报告",
        "details": "血压正常，血糖偏高，建议定期监测...",
        "recordDate": "2025-12-20",
        "hospital": "社区卫生服务中心",
        "doctorName": "李医生",
        "attachmentUrl": "https://example.com/checkup_2025.pdf",
        "notes": "需要复查血糖",
        "createdAt": "2025-12-20 10:30:00",
        "updatedAt": "2025-12-20 10:30:00"
      }
    ],
    "total": 15,
    "current": 1,
    "size": 10
  }
}
```

**特点**：
- 自动过滤当前用户的档案
- 支持按类型和时间范围筛选
- 按记录日期倒序（最新优先）

#### 1.2 获取所有健康档案（管理员/护工）
```
GET /api/health-records?page=1&size=10&userId=123&recordType=medication

参数说明：
- 管理员和护工可以查看所有记录
- 可选按userId筛选特定老人的记录
- 居民调用此接口会被限制为只看自己的
```

**权限控制**：
```java
String role = UserContext.getRole();
Long currentUserId = UserContext.getUserId();

QueryWrapper<HealthRecord> wrapper = new QueryWrapper<>();

// 居民只能查看自己的记录
if ("resident".equalsIgnoreCase(role)) {
  wrapper.eq("user_id", currentUserId);
} else {
  // 管理员和护工可以查看所有，也可以按userId筛选
  if (userId != null) {
    wrapper.eq("user_id", userId);
  }
}
```

#### 1.3 获取单条健康档案详情
```
GET /api/health-records/{id}

响应：{
  "code": 0,
  "message": "成功",
  "data": {
    "id": 1,
    "userId": 123,
    "recordType": "checkup",
    "title": "2025年度体检报告",
    ...
  }
}
```

**权限验证**：
```java
// 居民只能查看自己的记录
if ("resident".equalsIgnoreCase(role)) {
  if (currentUserId == null || !currentUserId.equals(record.getUserId())) {
    return ApiResponse.error("无权查看他人的健康档案");
  }
}
```

### 2. 操作接口

#### 2.1 创建健康档案
```
POST /api/health-records
请求体：{
  "userId": 123,                              // 可选：老人ID
  "recordType": "checkup",                   // 必填：记录类型
  "title": "2025年度体检报告",               // 必填：记录标题
  "details": "血压正常，血糖偏高...",       // 必填：记录内容
  "recordDate": "2025-12-20",                // 必填：记录日期
  "hospital": "社区卫生服务中心",           // 可选：医院名称
  "doctorName": "李医生",                    // 可选：医生名称
  "attachmentUrl": "https://example.com/file.pdf",  // 可选：附件
  "notes": "需要复查血糖"                   // 可选：备注
}

响应：{
  "code": 0,
  "message": "添加成功",
  "data": {
    "id": 1,
    "userId": 123,
    ...
  }
}
```

**后端逻辑**：
```java
@PostMapping
public ApiResponse<HealthRecord> create(@RequestBody HealthRecord record) {
  String role = UserContext.getRole();
  Long userId = UserContext.getUserId();
  
  // 1. 权限检查：居民无权新增
  if ("resident".equalsIgnoreCase(role)) {
    return ApiResponse.error("居民无权新增健康档案");
  }
  
  // 2. 如果未指定userId，使用当前登录用户的ID（护工为自己的档案）
  if (record.getUserId() == null) {
    record.setUserId(userId);
  }
  
  // 3. 自动记录时间戳
  record.setCreatedAt(LocalDateTime.now());
  record.setUpdatedAt(LocalDateTime.now());
  
  // 4. 保存到数据库
  boolean success = healthRecordService.save(record);
  if (success) {
    return ApiResponse.success("添加成功", record);
  }
  return ApiResponse.error("添加失败");
}
```

**关键点**：
- ✅ 仅管理员/护工可以新增
- ✅ 自动获取创建时间
- ✅ 支持指定userId为其他老人添加记录

#### 2.2 更新健康档案
```
PUT /api/health-records/{id}
请求体：{
  "recordType": "checkup",
  "title": "2025年度体检报告（更新）",
  "details": "更新后的内容...",
  "recordDate": "2025-12-20",
  "notes": "更新备注"
}

响应：{
  "code": 0,
  "message": "更新成功"
}
```

**权限控制**：
```java
@PutMapping("/{id}")
public ApiResponse<String> update(@PathVariable Long id, @RequestBody HealthRecord record) {
  HealthRecord existing = healthRecordService.getById(id);
  if (existing == null) {
    return ApiResponse.error("健康档案不存在");
  }
  
  String role = UserContext.getRole();
  
  // 居民无权编辑
  if ("resident".equalsIgnoreCase(role)) {
    return ApiResponse.error("居民无权编辑健康档案");
  }
  
  // 管理员和护工可以编辑所有记录
  record.setId(id);
  record.setUserId(existing.getUserId());  // 保持老人ID不变
  record.setCreatedAt(existing.getCreatedAt());  // 保持创建时间
  record.setUpdatedAt(LocalDateTime.now());  // 更新修改时间
  
  boolean success = healthRecordService.updateById(record);
  ...
}
```

#### 2.3 删除健康档案
```
DELETE /api/health-records/{id}

响应：{
  "code": 0,
  "message": "删除成功"
}
```

**权限控制**：
```java
@DeleteMapping("/{id}")
public ApiResponse<String> delete(@PathVariable Long id) {
  HealthRecord existing = healthRecordService.getById(id);
  if (existing == null) {
    return ApiResponse.error("健康档案不存在");
  }
  
  String role = UserContext.getRole();
  
  // 只有管理员可以删除
  if (!"admin".equalsIgnoreCase(role)) {
    return ApiResponse.error("仅管理员可删除健康档案");
  }
  
  boolean success = healthRecordService.removeById(id);
  ...
}
```

---

## 🎨 前端页面（HealthRecordView.vue）

### 1. 页面布局

#### 1.1 顶部操作栏
```vue
<div class="card-header">
  <span class="title">健康记录</span>
  <!-- 仅管理员和护工可以新增 -->
  <el-button v-if="canAdd" type="primary" @click="handleAdd">
    <i class="el-icon-plus"></i>
    新增记录
  </el-button>
</div>
```

**角色规则**：
- **管理员/护工**：显示"新增记录"按钮
- **居民**：不显示该按钮

#### 1.2 筛选栏

```vue
<el-row :gutter="20" class="search-row">
  <!-- 1. 按类型筛选 -->
  <el-col :span="6">
    <el-select v-model="filters.recordType" placeholder="请选择记录类型" clearable>
      <el-option label="全部" value=""></el-option>
      <el-option label="检查报告" value="checkup"></el-option>
      <el-option label="用药记录" value="medication"></el-option>
      <el-option label="诊疗记录" value="treatment"></el-option>
      <el-option label="其他" value="other"></el-option>
    </el-select>
  </el-col>
  
  <!-- 2. 按日期范围筛选 -->
  <el-col :span="6">
    <el-date-picker
      v-model="filters.dateRange"
      type="daterange"
      range-separator="至"
      start-placeholder="开始日期"
      end-placeholder="结束日期"
    />
  </el-col>
  
  <!-- 3. 操作按钮 -->
  <el-col :span="12" class="text-right">
    <el-button @click="handleReset">重置</el-button>
    <el-button type="primary" @click="fetchData">查询</el-button>
  </el-col>
</el-row>
```

**功能**：
- 按类型快速过滤
- 按日期范围查找（可选任意时间段）
- 重置清空所有筛选条件

#### 1.3 健康档案列表表格

| 列 | 宽度 | 说明 |
|----|------|------|
| ID | 80px | 记录编号 |
| 记录标题 | 150px+ | 记录的标题 |
| 记录类型 | 120px | 体检/用药/诊疗/其他 |
| 记录日期 | 120px | 医疗事件发生的日期 |
| 创建时间 | 160px | 记录创建的时间 |
| 操作 | 200px | 查看/编辑/删除 |

**状态颜色映射**：
```javascript
const getTypeColor = (type) => {
  const map = {
    checkup: 'success',    // 绿色 - 体检
    medication: 'warning', // 橙色 - 用药
    treatment: 'info',     // 蓝色 - 诊疗
    other: ''              // 默认 - 其他
  }
  return map[type] || ''
}
```

#### 1.4 操作按钮逻辑

```vue
<template #default="{ row }">
  <!-- 所有人都可以查看 -->
  <el-button link type="primary" @click="handleView(row)">查看</el-button>
  
  <!-- 仅管理员/护工可以编辑 -->
  <el-button
    v-if="canEdit"
    link
    type="primary"
    @click="handleEdit(row)"
  >编辑</el-button>
  
  <!-- 仅管理员可以删除 -->
  <el-button
    v-if="canDelete"
    link
    type="danger"
    @click="handleDelete(row)"
  >删除</el-button>
</template>
```

**权限矩阵**：
| 按钮 | admin | caregiver | resident |
|------|-------|-----------|----------|
| 查看 | ✅ | ✅ | ✅（自己的）|
| 新增 | ✅ | ✅ | ❌ |
| 编辑 | ✅ | ✅ | ❌ |
| 删除 | ✅ | ❌ | ❌ |

### 2. 新增/编辑对话框

```vue
<el-dialog
  v-model="dialogVisible"
  :title="isEdit ? '编辑健康记录' : '新增健康记录'"
  width="600px"
>
  <el-form :model="formData" :rules="rules" label-width="100px">
    <!-- 记录标题（必填） -->
    <el-form-item label="记录标题" prop="title">
      <el-input v-model="formData.title" placeholder="如：2025年度体检报告"></el-input>
    </el-form-item>
    
    <!-- 记录类型（必填） -->
    <el-form-item label="记录类型" prop="recordType">
      <el-select v-model="formData.recordType" placeholder="请选择记录类型">
        <el-option label="检查报告" value="checkup"></el-option>
        <el-option label="用药记录" value="medication"></el-option>
        <el-option label="诊疗记录" value="treatment"></el-option>
        <el-option label="其他" value="other"></el-option>
      </el-select>
    </el-form-item>
    
    <!-- 记录日期（必填） -->
    <el-form-item label="记录日期" prop="recordDate">
      <el-date-picker v-model="formData.recordDate" type="date"></el-date-picker>
    </el-form-item>
    
    <!-- 医院（可选） -->
    <el-form-item label="医院" prop="hospital">
      <el-input v-model="formData.hospital" placeholder="如：社区卫生服务中心"></el-input>
    </el-form-item>
    
    <!-- 医生（可选） -->
    <el-form-item label="医生" prop="doctorName">
      <el-input v-model="formData.doctorName" placeholder="医生姓名"></el-input>
    </el-form-item>
    
    <!-- 记录内容（必填，多行） -->
    <el-form-item label="记录内容" prop="details">
      <el-input
        v-model="formData.details"
        type="textarea"
        :rows="4"
        placeholder="请输入记录详细内容"
      ></el-input>
    </el-form-item>
    
    <!-- 备注（可选） -->
    <el-form-item label="备注" prop="notes">
      <el-input
        v-model="formData.notes"
        type="textarea"
        :rows="2"
        placeholder="如：需要复查血糖"
      ></el-input>
    </el-form-item>
  </el-form>
  
  <template #footer>
    <el-button @click="dialogVisible = false">取消</el-button>
    <el-button type="primary" @click="handleSave">保存</el-button>
  </template>
</el-dialog>
```

**表单验证规则**：
```javascript
const rules = {
  title: [
    { required: true, message: '请输入记录标题', trigger: 'blur' }
  ],
  recordType: [
    { required: true, message: '请选择记录类型', trigger: 'change' }
  ],
  recordDate: [
    { required: true, message: '请选择记录日期', trigger: 'change' }
  ],
  details: [
    { required: true, message: '请输入记录内容', trigger: 'blur' }
  ]
}
```

### 3. 查看详情对话框

```vue
<el-dialog v-model="viewDialogVisible" title="健康记录详情" width="600px">
  <el-descriptions :column="1" border>
    <el-descriptions-item label="记录标题">
      {{ viewData.title }}
    </el-descriptions-item>
    
    <el-descriptions-item label="记录类型">
      <el-tag :type="getTypeColor(viewData.recordType)">
        {{ getTypeLabel(viewData.recordType) }}
      </el-tag>
    </el-descriptions-item>
    
    <el-descriptions-item label="记录日期">
      {{ displayDate(viewData.recordDate) }}
    </el-descriptions-item>
    
    <el-descriptions-item label="医院">
      {{ viewData.hospital }}
    </el-descriptions-item>
    
    <el-descriptions-item label="医生">
      {{ viewData.doctorName }}
    </el-descriptions-item>
    
    <el-descriptions-item label="记录内容">
      {{ viewData.details }}
    </el-descriptions-item>
    
    <el-descriptions-item label="备注">
      {{ viewData.notes }}
    </el-descriptions-item>
    
    <el-descriptions-item label="创建时间">
      {{ formatTime({}, viewData.createdAt) }}
    </el-descriptions-item>
    
    <el-descriptions-item label="更新时间">
      {{ formatTime({}, viewData.updatedAt) }}
    </el-descriptions-item>
  </el-descriptions>
</el-dialog>
```

---

## 🗄️ 数据库设计

### 1. health_records 表结构

```sql
CREATE TABLE health_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  record_type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  record_date DATE NOT NULL,
  details LONGTEXT,
  hospital VARCHAR(255),
  doctor_name VARCHAR(100),
  attachment_url VARCHAR(500),
  notes TEXT,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  INDEX idx_user_id (user_id),
  INDEX idx_record_type (record_type),
  INDEX idx_record_date (record_date),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 2. 字段详解

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 记录ID | PK, AI |
| user_id | BIGINT | 老人用户ID | FK→users, NOT NULL |
| record_type | VARCHAR(50) | 记录类型 | checkup/medication/treatment/other |
| title | VARCHAR(255) | 记录标题 | NOT NULL |
| record_date | DATE | 记录日期 | NOT NULL |
| details | LONGTEXT | 记录详情 | 可空（大文本） |
| hospital | VARCHAR(255) | 医院名称 | 可空 |
| doctor_name | VARCHAR(100) | 医生姓名 | 可空 |
| attachment_url | VARCHAR(500) | 附件URL | 可空 |
| notes | TEXT | 备注 | 可空 |
| created_at | TIMESTAMP | 创建时间 | NOT NULL |
| updated_at | TIMESTAMP | 更新时间 | NOT NULL |

### 3. 索引优化

```sql
-- 快速查找某老人的所有健康档案
INDEX idx_user_id (user_id)

-- 快速按类型筛选
INDEX idx_record_type (record_type)

-- 快速按日期范围查询（如最近3个月的档案）
INDEX idx_record_date (record_date)

-- 快速按创建时间排序
INDEX idx_created_at (created_at)

-- 复合索引：查找某老人某类型的档案
INDEX idx_user_type (user_id, record_type)
```

---

## 📊 业务流程

### 1. 健康档案完整流程

```
【T1】老人进行医疗检查或诊疗
  └─ 地点：医院、诊所、体检中心等

【T2】护工或管理员获得检查结果
  └─ 获得途径：患者提供、医院发送、打印件等

【T3】输入健康档案
  护工/管理员操作：
  1. 点击"新增记录"
  2. 输入记录标题（如"2025年体检报告"）
  3. 选择记录类型（体检/用药/诊疗/其他）
  4. 选择记录日期（医疗事件发生的日期）
  5. 输入医院名称
  6. 输入医生名称
  7. 输入详细内容
  8. （可选）上传附件（PDF/图片）
  9. 点击"保存"

  系统操作：
  1. 前端表单验证
  2. 后端权限检查（仅admin/caregiver）
  3. 自动记录创建时间
  4. 保存到数据库
  5. 与老人的user_id关联

【T4】老人查看档案
  老人操作：
  1. 进入"健康记录"页面
  2. 可以按类型和日期范围筛选
  3. 点击"查看"了解详情
  4. （无法编辑或删除）

【T5】护工或管理员后续编辑
  如果发现错误或需要补充：
  1. 点击"编辑"按钮
  2. 修改相关内容
  3. 点击"保存"
  4. 系统自动更新修改时间

【T6】健康档案管理
  管理员可以：
  1. 删除过期或错误的档案
  2. 整理和维护档案
  3. 生成健康报告
  4. 导出档案用于医疗咨询

【T7】历史查询和分析
  利用健康档案进行：
  1. 长期健康趋势分析（如血糖变化）
  2. 疾病历史追踪
  3. 用药历史查询
  4. 就医频率统计
```

### 2. 多类型档案示例

```
【示例1：体检档案】
标题：2025年度体检报告
类型：checkup
日期：2025-12-20
医院：社区卫生服务中心
医生：李医生
内容：
  - 血压：140/90 mmHg（偏高）
  - 血糖：6.5 mmol/L（偏高）
  - 血脂：正常
  - 体重：68kg，身高：170cm，BMI：23.5
  - 建议：定期监测血糖，控制饮食

【示例2：用药档案】
标题：高血压用药记录
类型：medication
日期：2025-12-15
医院：医院门诊
医生：王医生
内容：
  开具处方：
  1. 硝苯地平（长效）5mg 每日一次
  2. 氯沙坦 50mg 每日一次
  3. 阿司匹林 100mg 每日一次
  用法：早晨服用

【示例3：诊疗档案】
标题：腰椎间盘突出手术记录
类型：treatment
日期：2025-12-10
医院：三级医院脊柱科
医生：张医生
内容：
  手术名称：腰椎微创融合术
  手术时间：90分钟
  麻醉：全身麻醉
  手术结果：成功，恢复良好
  出院指导：卧床休息2周，避免弯腰
```

### 3. 数据查询流程

```
【老人查看自己的档案】
老人进入页面 → 系统自动过滤该用户的档案 → 显示分页列表

【护工查看所有档案】
护工进入页面 → 显示所有老人的档案 → 可按userId筛选

【按类型查询】
1. 选择"用药记录"
2. 系统执行：WHERE record_type = 'medication'
3. 显示所有用药记录

【按日期范围查询】
1. 选择时间段：2025-01-01 至 2025-12-31
2. 系统执行：WHERE record_date BETWEEN '2025-01-01' AND '2025-12-31'
3. 显示该时间段的所有档案

【高级查询】
同时按类型和日期范围查询
WHERE user_id = ? 
  AND record_type = 'checkup' 
  AND record_date BETWEEN '2025-01-01' AND '2025-12-31'
ORDER BY record_date DESC
```

---

## 🔐 权限控制

### 1. 操作权限矩阵

| 操作 | admin | caregiver | resident |
|------|-------|-----------|----------|
| **查看所有档案** | ✅ | ✅ | ❌ |
| **查看自己的档案** | ✅ | ✅ | ✅ |
| **创建档案** | ✅ | ✅ | ❌ |
| **编辑档案** | ✅ | ✅ | ❌ |
| **删除档案** | ✅ | ❌ | ❌ |

### 2. 数据隔离实现

```java
// 前端
const isResident = computed(() => role.value === 'resident')
const canAdd = computed(() => isAdmin.value || isCaregiver.value)
const canDelete = computed(() => isAdmin.value)

// 查询：老人自动看自己的，护工/管理员看全部
const apiCall = isResident.value ? getMyHealthRecords : getAllHealthRecords

// 后端
if ("resident".equalsIgnoreCase(role)) {
  // 查询时只过滤自己的
  wrapper.eq("user_id", currentUserId);
  
  // 查看详情时验证权限
  if (!currentUserId.equals(record.getUserId())) {
    return ApiResponse.error("无权查看他人的健康档案");
  }
}
```

### 3. 创建时的用户关联

```java
// 护工为自己添加档案
POST /api/health-records
{
  "title": "今日体温记录",
  // 不填userId，系统自动使用护工自己的ID
}

// 管理员为特定老人添加档案
POST /api/health-records
{
  "userId": 123,  // 指定老人的user_id
  "title": "2025年体检"
}
```

---

## ⚠️ 已知问题与改进方向

### 问题1：缺少多媒体附件上传
**现状**：有attachmentUrl字段但前端未实现上传功能  
**改进**：
```vue
<!-- 添加文件上传组件 -->
<el-form-item label="附件" prop="attachment">
  <el-upload
    drag
    action="/api/upload"
    multiple
  >
    <el-icon class="el-icon-upload"></el-icon>
    <div class="el-upload__text">
      拖到此处，或 <em>点击上传</em> 体检报告、医生处方等文件
    </div>
  </el-upload>
</el-form-item>
```

### 问题2：缺少健康指标的结构化存储
**现状**：体检数据都存在文本details字段中，无法进行数据分析  
**改进**：
```java
// 添加专门字段存储关键指标
private Double bloodPressureSystolic;    // 收缩压
private Double bloodPressureDiastolic;   // 舒张压
private Double bloodSugar;               // 血糖
private Double cholesterol;              // 胆固醇
private Double weight;                   // 体重
private Double height;                   // 身高
private Double bmi;                      // BMI

// 这样可以用于趋势分析
List<HealthRecord> records = getRecords(userId, "checkup");
double[] bloodSugarTrend = records.stream()
  .map(r -> r.getBloodSugar())
  .toArray(Double[]::new);
```

### 问题3：缺少健康预警机制
**现状**：医生输入的诊断和建议无法自动触发提醒  
**改进**：
```java
// 如果检查到异常，自动创建任务或提醒
if (record.getBloodSugar() > 7.0) {
  // 创建提醒：该老人血糖偏高，需要复查
  remindService.createReminder(
    record.getUserId(),
    "血糖偏高，建议7天内复查",
    record.getRecordDate().plusDays(7)
  );
}
```

### 问题4：缺少档案的版本管理
**现状**：修改档案后无法看到之前的版本  
**改进**：
```java
// 实现软删除和版本追踪
@TableField("is_deleted")
private Boolean isDeleted;

@TableField("parent_id")  // 如果是修改版本，记录原版本ID
private Long parentId;

@TableField("version_number")
private Integer versionNumber;  // 第几个版本

// 修改时不是更新，而是新增一条记录
healthRecordService.save(new HealthRecord()
  .setParentId(originalRecord.getId())
  .setVersionNumber(originalRecord.getVersionNumber() + 1)
  .setUserId(originalRecord.getUserId())
  ...
);
```

### 问题5：缺少档案分享和打印功能
**现状**：档案只能在系统内查看，无法导出或分享给医生  
**改进**：
```vue
<!-- 添加导出和分享按钮 -->
<el-button link type="primary" @click="handleExport(row)">导出</el-button>
<el-button link type="primary" @click="handleShare(row)">分享</el-button>

// 导出为PDF
function handleExport(record) {
  // 转换为PDF格式
  const pdf = new PDFDocument();
  pdf.text(record.title, 100, 100);
  pdf.text(record.details, 100, 120);
  // ...
  pdf.pipe(fs.createWriteStream('record.pdf'));
  pdf.end();
}

// 分享到其他医疗系统
function handleShare(record) {
  // 生成分享链接或二维码
  const shareToken = generateToken(record.id);
  const shareUrl = `https://example.com/share?token=${shareToken}`;
}
```

### 问题6：缺少复诊提醒功能
**现状**：医生在notes中写"需要复查"，但系统无法自动提醒  
**改进**：
```java
// 提取notes中的关键词，自动创建任务
String[] keywords = {"复查", "复诊", "复检", "后续随访"};
for (String keyword : keywords) {
  if (record.getNotes().contains(keyword)) {
    // 创建复诊任务
    AppointmentRequest request = new AppointmentRequest()
      .setUserId(record.getUserId())
      .setServiceName("复诊")
      .setScheduledDate(record.getRecordDate().plusDays(30));  // 30天后复诊
    
    appointmentService.createRequest(request);
  }
}
```

### 问题7：缺少数据导出和报告生成
**现状**：无法生成健康报告或导出统计数据  
**改进**：
```java
// 生成健康年度报告
public HealthReport generateAnnualReport(Long userId, int year) {
  List<HealthRecord> records = getRecordsByYear(userId, year);
  
  HealthReport report = new HealthReport();
  report.setUserName(getUserName(userId));
  
  // 统计各类型档案数量
  long checkupCount = records.stream()
    .filter(r -> "checkup".equals(r.getRecordType()))
    .count();
  report.setCheckupCount(checkupCount);
  
  // 分析主要健康问题
  List<String> healthIssues = extractHealthIssues(records);
  report.setHealthIssues(healthIssues);
  
  // 生成建议
  List<String> recommendations = generateRecommendations(records);
  report.setRecommendations(recommendations);
  
  return report;
}
```

---

## 🧪 测试场景

### 1. 创建档案测试

**场景1.1：护工为老人创建体检档案**
```
操作：
1. 护工点击"新增记录"
2. 输入标题"2025年体检报告"
3. 选择类型"检查报告"
4. 选择日期"2025-12-20"
5. 输入医院"社区卫生服务中心"
6. 输入医生"李医生"
7. 输入内容"血压偏高..."
8. 点击"保存"

期望：
- 档案创建成功
- 显示在列表中
- 创建时间自动记录
```

**场景1.2：缺少必填字段**
```
操作：
1. 不填写记录标题
2. 直接点击"保存"

期望：表单验证失败，显示"请输入记录标题"错误
```

**场景1.3：居民无法创建档案**
```
角色：resident
期望：
- 看不到"新增记录"按钮
- 无法调用创建API
```

### 2. 查询和筛选测试

**场景2.1：居民查看自己的档案**
```
角色：resident（用户ID=123）
操作：进入"健康记录"页面

期望：仅显示该用户的档案
```

**场景2.2：按类型筛选**
```
操作：
1. 选择"用药记录"
2. 点击"查询"

期望：仅显示type='medication'的档案
```

**场景2.3：按日期范围筛选**
```
操作：
1. 选择日期范围：2025-01-01 至 2025-12-31
2. 点击"查询"

期望：仅显示该时间段内的档案
```

### 3. 编辑和删除测试

**场景3.1：护工编辑档案**
```
操作：
1. 点击某档案的"编辑"
2. 修改内容
3. 点击"保存"

期望：
- 档案内容更新
- 更新时间被记录
- 创建时间保持不变
```

**场景3.2：仅管理员可以删除**
```
角色：caregiver
操作：点击"删除"按钮

期望：按钮不显示或点击后提示"仅管理员可删除"
```

**场景3.3：删除后无法恢复**
```
操作：管理员删除一条档案

期望：档案从列表消失，无法通过查询找到
```

### 4. 权限测试

**场景4.1：居民无权编辑**
```
角色：resident
操作：尝试调用编辑API

期望：返回错误"居民无权编辑健康档案"
```

**场景4.2：护工可以查看所有档案**
```
角色：caregiver
期望：
- 可以看到所有老人的档案
- 可以按userId筛选特定老人
```

---

## 📈 实际应用示例

### 示例1：老人健康档案管理流程

```
【老人信息】
姓名：王奶奶
用户ID：123
年龄：75岁
主要疾病：高血压、糖尿病

【2025年健康档案】
1. 2025-01-15 | 体检报告 | 社区卫生服务中心
   内容：血压140/90（偏高），血糖6.8（偏高）
   建议：控制饮食，定期监测

2. 2025-03-20 | 用药记录 | 医院门诊
   处方：
   - 硝苯地平5mg（每日一次）
   - 氯沙坦50mg（每日一次）
   - 格列美脲2mg（每日两次）
   用法：早晨和晚间服用

3. 2025-06-10 | 体检报告 | 医院体检中心
   内容：3个月后复查，血糖略有改善（6.2）
   建议：继续规范用药

4. 2025-09-18 | 诊疗记录 | 医院门诊
   病情：因血糖控制不佳来就诊
   诊断：2型糖尿病，控制欠佳
   处方调整：增加一种药物
   建议：加强体育锻炼

5. 2025-12-20 | 体检报告 | 年度体检
   内容：年度体检，血压继续降低（130/85），血糖6.1
   建议：继续现有治疗方案，每3个月复查一次

【数据分析】
半年来的健康变化：
- 血压趋势：下降（140/90 → 130/85）
- 血糖趋势：下降（6.8 → 6.1）
- 用药调整：因糖尿病控制欠佳，已调整用药
- 就医频率：共就医3次（体检3次+诊疗1次）

【健康建议】
1. 坚持规范用药
2. 定期监测血糖
3. 加强体育锻炼
4. 控制饮食
5. 每3个月复查一次
```

### 示例2：护工使用档案协助工作

```
【护工张某今日任务】
早上：照顾王奶奶和李爷爷

【查阅王奶奶的健康档案】
最近体检：血糖6.1，需要控制饮食
当前用药：3种，需要按时监督
建议：加强体育锻炼
→ 张某：给王奶奶安排上午10点散步，午餐控制主食

【查阅李爷爷的健康档案】
最近诊疗：做过腰椎手术，需要卧床休息
当前限制：避免弯腰，禁止重体力劳动
→ 张某：帮李爷爷调整床位，提醒卧床休息

【档案的作用】
✅ 护工可以了解老人的健康状况
✅ 知道有哪些饮食禁忌
✅ 了解正在使用的药物
✅ 遵循医生的建议
✅ 及时发现潜在健康风险
```

---

## 🔌 与其他模块的集成

### 1. 与预约模块的集成

```
【使用场景】
- 老人的诊疗档案显示需要复查
- 系统自动生成复诊预约建议
- 护工可以快速为老人创建体检或诊疗预约
```

### 2. 与评价模块的集成

```
【使用场景】
- 诊疗档案可以记录医生或护工的评价
- 用于后续医疗质量评估
```

### 3. 与费用模块的集成

```
【使用场景】
- 体检或诊疗费用记录
- 从档案中提取医疗费用信息
- 用于费用统计和分析
```

---

## 总结

健康档案模块是**老人健康管理的基础设施**。

✅ **核心价值**：
- 完整记录老人的医疗历史
- 支持多类型档案（体检/用药/诊疗/其他）
- 时间范围查询，快速定位关键信息
- 权限隔离，保护隐私

✅ **关键功能**：
- 创建、编辑、删除档案（权限控制）
- 按类型和日期范围筛选
- 查看详情和打印
- 与医院、医生信息关联

⚠️ **主要改进方向**：
- 文件上传和附件管理
- 结构化健康指标存储
- 健康预警和复诊提醒
- 版本管理和修改历史
- 档案导出和分享
- 健康报告生成
- 健康趋势分析

该模块展示了**医疗数据的规范存储和查询**，是养老系统中的重要功能。

