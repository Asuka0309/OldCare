# 费用管理模块 - 详细分析

## 📌 模块概述

**模块名称**：费用管理（Fee Record）  
**核心功能**：费用记录的创建、支付标记、退款申请与审批、分页查询与数据隔离展示  
**适用角色**：管理员（创建/支付/审批）、居民（查看自己的费用/申请退款）、护工（只读查看）  
**关键特性**：自动/手动费用生成、严格的权限校验、兼容双数据模型（users 与 elderly_info）、退款审批流

---

## 🎯 核心功能

### 1. 费用记录创建
- 自动生成：预约完成后由系统生成费用（推荐路径）。
- 手动创建：仅管理员可手动创建，必须关联预约ID，校验 `amount > 0` 与居民ID存在。
- 字段初始化：`status=未支付`，写入 `created_time/updated_time`。

### 2. 支付标记（审批确认）
- 仅管理员可执行，且费用状态必须为“未支付”。
- 若关联预约，必须确认预约状态为“已完成”。
- 更新为“已支付”，写入 `payment_time` 与 `updated_time`。

### 3. 退款申请与审批
- 居民可对“已支付”费用申请退款，状态改为“退款申请中”。
- 审批：管理员同意→“已退款”并写入 `refund_time`；管理员拒绝→恢复为“已支付”。
- 居民身份校验：
  - 支持两种 residentId 存储：`users.id`（新数据）或 `elderly_info.id`（旧数据）。
  - 同时兼容通过 `elderly_info.user_id` 关联判定“本人”。

### 4. 分页查询与数据隔离
- 管理员/护工：可查看所有记录（护工只读）。
- 居民：只能查看自己的记录，兼容两种 ID 口径（users/elderly_info）。
- 支持筛选：`residentId` 与 `status`，按 `created_time` 倒序。
- 返回时填充展示辅助字段：`elderlyId` 与 `residentName`（见“显示兼容”）。

---

## 📡 API 接口

### 1. 新增费用记录（手动）
```
POST /api/fee-record
权限：仅管理员
请求体：{ appointmentId, residentId | elderlyId, amount, serviceName?, feeType?, remark? }
响应：{ code, message, data: FeeRecord }
```

校验要点：
- `appointmentId` 必填；
- `residentId`/`elderlyId` 二选一→统一设为 `residentId`；
- `amount > 0`；
- 初始化状态为“未支付”。

### 2. 标记支付
```
PUT /api/fee-record/{id}/pay
权限：仅管理员
前置条件：status=未支付；如有关联预约，必须 status=已完成
响应：{ code, message }
```

### 3. 申请退款（居民）
```
PUT /api/fee-record/{id}/refund
权限：居民（本人记录）
前置条件：status=已支付（非已退款/非退款申请中）
响应：{ code, message }
```

本人校验规则（三路径）：
- `residentId == userId`（users.id）；
- `residentId` 作为 `elderly_info.id` → `elderly_info.user_id == userId`；
- 使用 `elderlyId` 兼容字段时同第二条相同逻辑。

### 4. 审批退款（管理员）
```
PUT /api/fee-record/{id}/approve-refund
请求体：{ approved: boolean }
响应：
- approved=true → status=已退款, refund_time=now
- approved=false → status=已支付
```

### 5. 按居民查询费用记录
```
GET /api/fee-record/by-resident/{residentId}?current=1&size=10
权限：管理员/护工（读）、居民（本人）
响应：{ records, total, current, size }
```

返回增强：为每条记录填充 `elderlyId` 与 `residentName`（见显示兼容）。

### 6. 分页查询费用记录（通用）
```
GET /api/fee-record?current=1&size=10&residentId=&status=
角色：
- 管理员/护工：全量（可筛选）
- 居民：仅本人（兼容两种ID）
响应：{ records, total, current, size }
```

---

## 🎨 前端页面

### 1. 页面：FeeRecordView.vue
- 查询筛选：按居民下拉（兼容 elderly/users 两源）、支付状态过滤。
- 表格展示：ID、预约ID、服务名称、居民、金额、状态、支付时间、创建时间、操作。
- 操作按钮：
  - 管理员：标记支付、同意/拒绝退款；
  - 居民：申请退款（本人且 `status=已支付`）；
  - 护工：不展示任何操作按钮（只读）。
- 新增费用对话框：提示“费用应通过完成预约自动生成”，允许管理员手动录入预约ID、居民与金额。
- 名称解析：`findName(id)` 同时在 `elderlyOptions` 与 `userOptions` 里查找，并兼容 `elderly_info.user_id` 关系。

### 2. 交互与API封装
- API：
  - [oldcare-system-front/src/api/feeRecord.js](oldcare-system-front/src/api/feeRecord.js)
  - 方法：`fetchFeeRecords`、`createFeeRecord`、`payFeeRecord`、`refundFeeRecord`、`approveRefund`、`getFeeRecordsByResident`
- 加载居民名单：并行请求 `elderly` 与 `users(role=resident)`，支持两种数据来源。
- 退款确认与审批确认：使用 `ElMessageBox.confirm` 二次确认。

---

## 🗄️ 数据模型

### 1. 费用记录表：fee_records
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| appointment_id | BIGINT | 关联预约ID |
| resident_id | BIGINT | 居民ID（可为 users.id 或 elderly_info.id） |
| service_name | VARCHAR | 服务名称（冗余便展示） |
| amount | DECIMAL(10,2) | 金额 |
| fee_type | VARCHAR | 类型：service/materials/other |
| status | VARCHAR | 未支付/已支付/退款申请中/已退款 |
| due_date | DATE | 应付日期 |
| payment_time | DATETIME | 支付时间 |
| refund_time | DATETIME | 退款时间 |
| remark | VARCHAR | 备注 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

### 2. 显示兼容字段填充
- 后端在返回时调用 `setElderlyIdForRecords()`：
  - 若 `resident_id` 是 `users.id`：通过 `elderly_info.user_id` 映射出 `elderlyId` 与姓名；
  - 若 `resident_id` 是 `elderly_info.id`：直接使用并尝试反查 `user.realName`。
- 统一设置：`record.elderlyId` 与 `record.residentName`，便于前端展示。

### 3. 索引建议
- `fee_records(resident_id, status, created_time)` 复合索引。
- `fee_records(appointment_id)`：便于预约过滤与联查。

---

## 🔄 业务流程

### 1. 自动费用生成（推荐）
```
预约完成（Appointment.status=已完成）
    ↓
系统自动创建费用记录（未支付）
    ↓
管理员审批支付（支付标记 → 已支付）
    ↓
居民如有异议可申请退款（退款申请中）
    ↓
管理员审批退款（通过 → 已退款 / 拒绝 → 已支付）
```

### 2. 手动费用创建（管理员）
- 输入已存在的 `appointmentId` + `residentId/elderlyId` + `amount`。
- 保存后进入“未支付”状态，后续走支付标记与可能的退款流程。

### 3. 居民数据隔离
- 查询时按用户两口径隔离（users.id 与 elderly_info.id），仅返回本人相关记录。

---

## 🔐 权限与角色

| 功能 | admin | caregiver | resident |
|------|-------|-----------|----------|
| 新增费用（手动） | ✅ | ❌ | ❌ |
| 标记支付 | ✅ | ❌ | ❌ |
| 申请退款 | ❌ | ❌ | ✅（本人记录） |
| 审批退款 | ✅ | ❌ | ❌ |
| 查询费用 | ✅ | ✅（只读） | ✅（本人） |

后端强校验：统一通过 `UserContext` 获取 `role/userId`，在 Controller 层做严格判断。

---

## 📏 校验与边界

- 金额校验：`amount.signum() > 0`。 
- 状态流转：
  - 未支付 → 已支付（管理员）
  - 已支付 → 退款申请中（居民）
  - 退款申请中 → 已退款 / 已支付（管理员审批）
- 预约校验：支付标记时，如有关联预约，必须为“已完成”。
- 兼容数据：居民ID可能为 `users.id` 或 `elderly_info.id`，在查询/展示时需兼容两种存储方式。

---

## ⚠️ 已知问题与优化建议

1. 数据模型冗余与复杂关联  
   - 现状：`resident_id` 双口径（users/elderly），后端需做多次判定与映射。  
   - 建议：统一口径为 `users.id`，保留 `elderly_id` 明确字段，减少歧义。

2. 审批日志与审计  
   - 建议：为支付与退款审批写操作日志（操作者、时间、原因），便于审计与追溯。

3. 退款规则与时间窗  
   - 建议：增加退款申请时间限制与原因字段；支持部分退款或材料费区分。

4. 统一状态枚举  
   - 建议：后端引入枚举常量，前后端统一使用，减少魔法字符串。

5. 性能优化  
   - 建议：对常用筛选加复合索引；分页查询使用轻量字段；必要时引入缓存。

6. 前端体验  
   - 建议：费用详情弹窗、导出 CSV、状态颜色统一规范、错误提示更清晰。

---

## 🧪 测试场景

### 1. 创建与支付
- 场景1：管理员手动创建费用（合法参数）→ 成功，状态未支付。
- 场景2：管理员为未支付费用标记支付，关联预约状态为已完成→ 成功，写入支付时间。
- 场景3：关联预约未完成时标记支付→ 失败提示。

### 2. 退款申请与审批
- 场景4：居民对本人“已支付”费用申请退款→ 成功，状态改为退款申请中。
- 场景5：居民对他人费用申请退款→ 403 拒绝。
- 场景6：管理员同意退款→ 状态改为已退款并写入退款时间。
- 场景7：管理员拒绝退款→ 状态恢复为已支付。

### 3. 查询与隔离
- 场景8：居民分页查询仅返回本人相关记录（兼容 users/elderly 两口径）。
- 场景9：管理员按状态筛选与居民筛选返回正确集。
- 场景10：护工只读查看，不显示任何操作按钮。

---

## 🔌 模块集成

- 与预约管理（Appointment）：支付标记校验“已完成”。
- 与用户/老人（User/Elderly）：居民归属判定与展示名称填充。
- 与收入统计（Income）：收入统计仅纳入“已支付”费用，退款不计入。
- 与通知（可扩展）：退款审批结果、支付成功可触发通知。

---

## 总结

费用管理模块完整覆盖费用的创建、支付、退款申请与审批，并通过严格的权限控制与数据隔离保障正确性：
- ✅ 管理员掌控创建与审批，护工只读，居民自助申请退款；
- ✅ 兼容历史数据（users/elderly 双口径）；
- ✅ 查询返回填充展示辅助信息，前端显示一致；
- ✅ 与预约、收入统计等模块紧密联动。

优先改进方向：统一 ID 口径与状态枚举、完善审批日志、优化索引与分页性能、增强前端交互与报表导出。
