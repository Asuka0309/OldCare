# 预约管理模块 - 前后端文件映射清单

> 本清单聚焦“预约的创建 / 编辑 / 确认 / 完成 / 取消 / 删除”全流程，以及“完成预约 → 自动生成费用记录”的关键链路与代码位置。

---

## 前端文件（Vue 3 + Vite）

- 预约管理页面（列表 + 新建/编辑弹窗 + 状态操作）： [oldcare-system-front/src/views/AppointmentView.vue](oldcare-system-front/src/views/AppointmentView.vue)
- 预约 API 封装（list/create/update/cancel/confirm/complete/getById/delete）： [oldcare-system-front/src/api/appointment.js](oldcare-system-front/src/api/appointment.js)

### 预约页面依赖的下拉数据（引用模块）

- 老人下拉： [oldcare-system-front/src/api/elderly.js](oldcare-system-front/src/api/elderly.js)（`fetchAllElderly` → `/api/elderly/all`）
- 护工下拉： [oldcare-system-front/src/api/caregiver.js](oldcare-system-front/src/api/caregiver.js)（`fetchAllCaregivers` → `/api/caregiver/all`）
- 服务下拉（同步价格 `syncPrice`）： [oldcare-system-front/src/api/service.js](oldcare-system-front/src/api/service.js)（`fetchAllServices` → `/api/service/all`）

### 通用依赖（鉴权与路由）

- HTTP 基址与 Token 注入（`baseURL=/api`，Authorization: Bearer ...）： [oldcare-system-front/src/api/http.js](oldcare-system-front/src/api/http.js)
- 登录态存储（sessionStorage）： [oldcare-system-front/src/store/auth.js](oldcare-system-front/src/store/auth.js)
- 路由与角色守卫（含 `/appointments` 路由）： [oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js)

---

## 后端文件（Spring Boot + MyBatis-Plus）

- 预约控制器（接口入口 + 费用生成 + 级联删除）： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)
- 预约 Service（MyBatis-Plus ServiceImpl）： [oldcare-system/src/main/java/com/example/oldcaresystem/service/AppointmentService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/AppointmentService.java)
- 预约实体（映射 appointments 表）： [oldcare-system/src/main/java/com/example/oldcaresystem/entity/Appointment.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Appointment.java)
- 预约 Mapper： [oldcare-system/src/main/java/com/example/oldcaresystem/mapper/AppointmentMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/AppointmentMapper.java)

### 完成预约 → 自动生成费用（关联模块）

- 费用记录实体： [oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java)
- 费用记录 Service： [oldcare-system/src/main/java/com/example/oldcaresystem/service/FeeRecordService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/FeeRecordService.java)
- 费用记录 Controller（支付/退款/审批等后续流程）： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeeRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeeRecordController.java)

### 预约创建时的引用数据（关联模块）

- 老人信息（校验/取 userId）： `ElderlyInfoService` / `ElderlyInfo`
  - 服务与实体在 [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java) 中注入使用
- 护工信息（校验 provider_id）： `CaregiverService` / `Caregiver`
- 服务项目（用于继承价格）： `ServiceManageService` / `Service`

### 鉴权与数据隔离（影响预约列表可见范围）

- 用户上下文（取 role/userId）： [oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java](oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java)
- 安全规则（是否需要登录）： [oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java](oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java)

---

## 接口清单（路径映射）

> 前端 `http.js` 的 `baseURL` 是 `/api`。

- 分页查询预约：`GET /api/appointment?current=1&size=10&elderlyId=&status=`
  - 前端： [oldcare-system-front/src/api/appointment.js](oldcare-system-front/src/api/appointment.js)（`list`） + [oldcare-system-front/src/views/AppointmentView.vue](oldcare-system-front/src/views/AppointmentView.vue)
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)

- 创建预约：`POST /api/appointment`
  - 前端： [oldcare-system-front/src/api/appointment.js](oldcare-system-front/src/api/appointment.js)（`create`）
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)

- 取消预约：`PUT /api/appointment/{id}/cancel`
- 确认预约：`PUT /api/appointment/{id}/confirm`
- 完成预约（生成费用）：`PUT /api/appointment/{id}/complete`
  - 前端： [oldcare-system-front/src/api/appointment.js](oldcare-system-front/src/api/appointment.js)
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)

- 获取单个预约：`GET /api/appointment/{id}`
- 删除预约（管理员）：`DELETE /api/appointment/{id}`（包含删除费用记录与评价记录）

---

## 关键链路（从代码角度）

- 选择服务后自动同步费用：
  - `AppointmentView.vue` 的 `syncPrice()` 使用 `serviceOptions`（来自 `/api/service/all`）
  - 入口： [oldcare-system-front/src/views/AppointmentView.vue](oldcare-system-front/src/views/AppointmentView.vue)

- 完成预约自动生成费用记录：
  - 入口：`PUT /api/appointment/{id}/complete`
  - 逻辑：校验状态=已确认 → 更新预约状态=已完成 → 若 fee_records 中 appointment_id 不存在则创建
  - 入口文件： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)
  - 费用实体： [oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java)

- 护工数据隔离（只看自己的预约）：
  - `GET /api/appointment` 中通过 `UserContext.getRole()` 判断 caregiver，并用 `caregivers.user_id` 查出护工记录，再过滤 `provider_id`
  - 入口文件： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)

- 删除预约级联：
  - 先删 fee_records（appointment_id）→ 再删 evaluations（appointment_id）→ 再删 appointments
  - 入口文件： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)

---

## 数据库表

- SQL 脚本（包含 appointments/fee_records 等表）： [oldcare-system/src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)

---

## 备注

- 预约更新接口已对齐为：`PUT /api/appointment`
  - 前端： [oldcare-system-front/src/api/appointment.js](oldcare-system-front/src/api/appointment.js)
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)