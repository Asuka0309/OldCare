# 服务项目管理模块 - 详细分析

## 📌 模块概述

**模块名称**：服务项目管理  
**核心功能**：服务项目的增删改查、定价、分类管理  
**适用角色**：系统管理员（增删改查）、其他用户（查看）  
**关键特性**：灵活的服务定价、服务分类、服务状态管理、预约时的服务选择

---

## 🎯 核心功能

### 1. 服务项目定义

服务项目是整个系统的**基础数据**，定义了养老机构能提供哪些服务以及如何收费。

#### 1.1 服务类型

系统支持多种服务类型（可自定义扩展）：

| 服务类型 | 说明 | 典型时长 | 参考价格 |
|---------|------|---------|---------|
| 生活护理 | 日常生活照料、卫生护理 | 60-120分钟 | 50-100元 |
| 医疗护理 | 药物管理、健康检查 | 30-60分钟 | 80-150元 |
| 心理关怀 | 心理咨询、精神陪护 | 60分钟 | 60-100元 |
| 健康检查 | 定期体检、血压测量 | 30-45分钟 | 30-60元 |
| 陪护服务 | 陪同外出、陪聊天 | 60-240分钟 | 40-80元 |
| 康复锻炼 | 物理治疗、功能恢复 | 60分钟 | 70-120元 |
| 营养配餐 | 特殊饮食安排 | 0分钟 | 20-50元 |

#### 1.2 服务属性

每个服务项目包含以下核心属性：

```java
Service {
  id              // 唯一标识
  serviceName     // 服务名称（如"生活护理基础包"）
  serviceType     // 服务类型（如"生活护理"）
  description     // 服务描述（详细说明服务内容）
  price           // 服务价格（单位：元，支持小数）
  durationMinutes // 服务时长（单位：分钟）
  status          // 服务状态（1=可用, 0=禁用）
  createdTime     // 创建时间
  updatedTime     // 更新时间
}
```

---

## 📡 API 接口

### 1. 服务查询接口

#### 1.1 分页查询服务列表
```
GET /api/service?current=1&size=10&serviceName=护理
参数：
  - current: 当前页码（默认1）
  - size: 每页条数（默认10）
  - serviceName: 服务名称搜索（模糊匹配）

响应：{
  "code": 0,
  "message": "成功",
  "data": {
    "records": [
      {
        "id": 1,
        "serviceName": "生活护理基础包",
        "serviceType": "生活护理",
        "description": "每天2小时的生活照料服务",
        "price": 50.00,
        "durationMinutes": 120,
        "status": 1,
        "createdTime": "2025-12-27 10:00:00",
        "updatedTime": "2025-12-27 10:00:00"
      }
    ],
    "total": 8,
    "current": 1,
    "size": 10
  }
}
```

**说明**：
- 仅返回状态=1（可用）的服务
- 支持按服务名称模糊查询
- 分页返回，每页最多10条（默认）

#### 1.2 查询所有可用服务（不分页）
```
GET /api/service/all

响应：{
  "code": 0,
  "message": "成功",
  "data": [
    {
      "id": 1,
      "serviceName": "生活护理基础包",
      "serviceType": "生活护理",
      "description": "每天2小时的生活照料服务",
      "price": 50.00,
      "durationMinutes": 120,
      "status": 1,
      "createdTime": "2025-12-27 10:00:00",
      "updatedTime": "2025-12-27 10:00:00"
    }
  ]
}
```

**说明**：
- 不分页，直接返回所有可用服务
- 用于下拉列表、选择框等场景
- **在预约时调用此接口填充服务选择列表**

#### 1.3 查询单个服务
```
GET /api/service/{id}

响应：{
  "code": 0,
  "message": "成功",
  "data": {
    "id": 1,
    "serviceName": "生活护理基础包",
    ...
  }
}
```

### 2. 服务管理接口（仅管理员）

#### 2.1 新增服务
```
POST /api/service
请求体：{
  "serviceName": "医疗护理高级包",
  "serviceType": "医疗护理",
  "description": "每周一次的专业医疗护理",
  "price": 150.00,
  "durationMinutes": 60,
  "status": 1
}

响应：{
  "code": 0,
  "message": "新增成功",
  "data": {
    "id": 9,
    "serviceName": "医疗护理高级包",
    ...
    "createdTime": "2025-12-27 14:30:00"
  }
}
```

**后端处理**：
```java
@PostMapping
public ResponseUtil<Service> add(@RequestBody Service service) {
  service.setCreatedTime(LocalDateTime.now());
  service.setUpdatedTime(LocalDateTime.now());
  serviceManageService.save(service);
  return ResponseUtil.success("新增成功", service);
}
```

#### 2.2 修改服务
```
PUT /api/service
请求体：{
  "id": 1,
  "serviceName": "生活护理基础包（升级版）",
  "price": 60.00,
  ...
}

响应：{
  "code": 0,
  "message": "修改成功",
  "data": { ... }
}
```

#### 2.3 删除服务
```
DELETE /api/service/{id}

响应：{
  "code": 0,
  "message": "删除成功",
  "data": null
}
```

**注意**：
- 删除时应检查是否有关联的预约
- 当前未实现关联检查，可能导致数据不一致
- ⚠️ **改进建议**：删除前验证是否有未完成的预约

---

## 🎨 前端页面（ServiceView.vue）

### 1. 页面布局

#### 1.1 搜索栏
```vue
<div class="search-bar">
  <el-input v-model="query.serviceName" placeholder="按服务名搜索" />
  <el-button type="primary" @click="openForm()">新增</el-button>
</div>
```

**功能**：
- 按服务名称搜索（实时查询）
- 新增服务按钮（仅管理员可见）

#### 1.2 服务列表表格

| 列 | 宽度 | 说明 |
|---|----|------|
| 名称 | 160px | 服务项目名称 |
| 类型 | 140px | 服务分类 |
| 描述 | 可变 | 服务详细描述（超长省略） |
| 价格 | 110px | 服务单价（元） |
| 时长 | 120px | 服务时长（分钟） |
| 状态 | 90px | 可用/禁用 |
| 操作 | 170px | 编辑、删除 |

**表格特点**：
- size="small"：紧凑显示
- stripe：斑马纹背景便于阅读
- 描述列超长文本自动省略显示

#### 1.3 分页器
```vue
<el-pagination
  layout="total, prev, pager, next, jumper"
  :current-page="query.current"
  :page-size="query.size"
  :total="total"
/>
```

### 2. 新增/编辑对话框

#### 2.1 表单字段

```vue
<el-form-item label="名称" prop="serviceName">
  <el-input v-model="form.serviceName" />
</el-form-item>

<el-form-item label="类型" prop="serviceType">
  <el-input v-model="form.serviceType" />
</el-form-item>

<el-form-item label="描述" prop="description">
  <el-input v-model="form.description" type="textarea" :rows="2" />
</el-form-item>

<el-form-item label="价格" prop="price">
  <el-input-number v-model="form.price" :min="0" :step="10" />
</el-form-item>

<el-form-item label="时长(分钟)" prop="durationMinutes">
  <el-input-number v-model="form.durationMinutes" :min="15" :step="15" />
</el-form-item>

<el-form-item label="状态" prop="status">
  <el-select v-model="form.status">
    <el-option label="可用" :value="1" />
    <el-option label="禁用" :value="0" />
  </el-select>
</el-form-item>
```

#### 2.2 表单验证规则

```javascript
const rules = {
  serviceName: [
    { required: true, message: '请输入名称', trigger: 'blur' }
  ],
  price: [
    { required: true, message: '请输入价格', trigger: 'blur' }
  ]
}
```

**验证说明**：
- 名称：必填
- 价格：必填
- 其他字段：可选

#### 2.3 数据约束

```javascript
const form = reactive({
  id: null,
  serviceName: '',           // 字符串，不超过50字
  serviceType: '',           // 字符串，不超过30字
  description: '',           // 字符串，可较长
  price: 50,                 // 数字，最小0，步长10
  durationMinutes: 60,       // 数字，最小15，步长15
  status: 1                  // 1或0
})
```

### 3. 操作流程

#### 3.1 新增服务流程

```
点击"新增"按钮
  ↓
打开新增对话框
  ├─ 清空表单
  └─ 设置默认值：price=50, durationMinutes=60, status=1
  ↓
用户填写表单
  ├─ 输入服务名称
  ├─ 输入服务类型
  ├─ 输入服务描述
  ├─ 输入价格（数字输入框）
  ├─ 输入时长（数字输入框，15分钟递增）
  └─ 选择状态（可用/禁用）
  ↓
点击"保存"按钮
  ├─ 前端表单验证
  ├─ 检查名称和价格非空
  └─ 发送POST请求到/api/service
  ↓
后端处理
  ├─ 新增服务记录
  ├─ 自动设置createdTime和updatedTime
  └─ 返回成功响应
  ↓
关闭对话框
  ↓
刷新服务列表
```

#### 3.2 编辑服务流程

```
点击"编辑"按钮
  ↓
打开编辑对话框
  └─ 填充当前服务的数据
  ↓
用户修改表单
  ├─ 修改任意字段
  └─ 名称无法修改的考虑
  ↓
点击"保存"按钮
  ├─ 前端表单验证
  └─ 发送PUT请求到/api/service
  ↓
后端处理
  ├─ 更新服务记录
  ├─ 自动更新updatedTime
  └─ 返回成功响应
  ↓
关闭对话框
  ↓
刷新服务列表
```

#### 3.3 删除服务流程

```
点击"删除"按钮
  ↓
显示确认对话框
  └─ 提示"确认删除 [服务名称] 吗？"
  ↓
用户点击"删除"确认
  ↓
发送DELETE请求到/api/service/{id}
  ↓
后端处理
  ├─ 删除服务记录
  └─ 返回成功响应
  ↓
刷新服务列表
```

---

## 🗄️ 数据库设计

### 1. services 表结构

```sql
CREATE TABLE services (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  service_name VARCHAR(50) NOT NULL,
  service_type VARCHAR(30),
  description TEXT,
  price DECIMAL(10, 2) NOT NULL,
  duration_minutes INT,
  status INT DEFAULT 1,
  created_time TIMESTAMP,
  updated_time TIMESTAMP,
  INDEX idx_service_name (service_name),
  INDEX idx_service_type (service_type),
  INDEX idx_status (status)
);
```

### 2. 字段详解

| 字段名 | 类型 | 长度 | 说明 | 约束 |
|--------|------|------|------|------|
| id | BIGINT | - | 服务ID | PK, AI |
| service_name | VARCHAR | 50 | 服务名称 | NOT NULL |
| service_type | VARCHAR | 30 | 服务类型 | 可空 |
| description | TEXT | - | 服务描述 | 可空 |
| price | DECIMAL | 10,2 | 服务价格（元） | NOT NULL |
| duration_minutes | INT | - | 服务时长（分钟） | 可空 |
| status | INT | - | 状态（1可用/0禁用） | DEFAULT 1 |
| created_time | TIMESTAMP | - | 创建时间 | 自动赋值 |
| updated_time | TIMESTAMP | - | 更新时间 | 自动赋值 |

### 3. 索引设计

```sql
-- 加速服务名称搜索
INDEX idx_service_name (service_name)

-- 加速按类型筛选
INDEX idx_service_type (service_type)

-- 加速按状态筛选（查询可用服务时）
INDEX idx_status (status)
```

### 4. 关联关系

```
services（服务表）
  ↓ 一对多
appointments（预约表）
  ↑ 多对一
  └─ service_id 外键关联
```

**说明**：
- 一个服务可以对应多个预约
- 删除服务时应考虑是否有关联预约

---

## 💰 计价策略

### 1. 价格设定

**当前模式**：按服务项目统一定价

```
价格 = 服务单价
总费用 = 价格（预约时直接继承）
```

**示例**：
- 生活护理基础包：¥50/次
- 医疗护理：¥150/次
- 康复锻炼：¥80/次

### 2. 价格字段

```java
private BigDecimal price;  // 使用BigDecimal精确计算，避免浮点误差
```

**优点**：
- 使用 BigDecimal 保证金钱计算精度
- 避免浮点数运算导致的误差
- 支持两位小数（如¥99.99）

### 3. 费用记录关联

当完成预约时，系统自动生成费用记录：

```java
// 从Service表获取价格
Service service = serviceManageService.getById(appointment.getServiceId());

// 创建费用记录
FeeRecord feeRecord = new FeeRecord();
feeRecord.setAmount(service.getPrice());  // 继承服务价格
feeRecord.setStatus("未支付");
```

### 4. 定价管理

**修改价格的影响**：
- ✅ **仅影响新创建的预约**：修改服务价格后，新预约使用新价格
- ❌ **不影响已有预约**：现有预约的费用保持不变

**示例**：
```
时间1：服务A定价¥50
预约1：完成后生成费用¥50

时间2：管理员修改服务A价格为¥60

预约2：完成后生成费用¥60
预约1的费用仍然是¥50（不变）
```

---

## 🔄 业务流程

### 1. 服务生命周期

```
创建服务
  ↓
编辑服务信息或价格
  ↓
在预约中选择该服务
  ├─ 预约时继承当前价格
  └─ 预约时继承当前时长
  ↓
预约完成
  ├─ 自动生成费用记录
  └─ 使用完成时的服务价格
  ↓
禁用服务（不再提供）
  ├─ 隐藏于选择列表中
  └─ 现有预约不受影响
  ↓
删除服务（可选）
  └─ 仅当无关联预约时
```

### 2. 服务在预约中的应用

#### 2.1 预约创建时

```
用户创建预约
  ↓
选择服务项目
  └─ 调用 GET /api/service/all
     获取所有可用服务列表
  ↓
系统查询该服务信息
  ├─ 获取服务价格
  ├─ 获取服务时长
  └─ 自动填充费用字段
  ↓
完成预约创建
  └─ 保存 serviceId、totalAmount
```

**前端代码（AppointmentView.vue）**：

```javascript
// 预约表单中
<el-form-item label="服务" prop="serviceId">
  <el-select v-model="form.serviceId" @change="syncPrice">
    <el-option v-for="s in serviceOptions" :key="s.id" 
      :label="`${s.serviceName} / ￥${s.price}`" 
      :value="s.id" />
  </el-select>
</el-form-item>

// 当选择服务时，自动同步价格
function syncPrice() {
  const service = serviceOptions.find(s => s.id === form.serviceId)
  if (service) {
    form.totalAmount = service.price
  }
}
```

#### 2.2 预约完成时

```
点击"完成预约"
  ↓
后端处理
  ├─ 更新预约状态为"已完成"
  ├─ 查询关联的服务信息
  ├─ 获取预约保存的totalAmount
  └─ 生成费用记录
      ├─ appointmentId
      ├─ residentId
      ├─ serviceName
      ├─ amount（使用预约中保存的totalAmount）
      ├─ status = "未支付"
      └─ createdTime
  ↓
返回"预约已完成，费用记录已生成"
```

---

## 🎛️ 权限控制

### 1. 操作权限

| 操作 | admin | caregiver | resident |
|------|-------|-----------|----------|
| **查看服务列表** | ✅ | ✅ | ✅ |
| **查看服务详情** | ✅ | ✅ | ✅ |
| **新增服务** | ✅ | ❌ | ❌ |
| **编辑服务** | ✅ | ❌ | ❌ |
| **删除服务** | ✅ | ❌ | ❌ |
| **禁用服务** | ✅ | ❌ | ❌ |

### 2. 前端权限控制

```vue
<template>
  <!-- 新增按钮仅管理员可见 -->
  <el-button v-if="isAdmin" type="primary" @click="openForm()">新增</el-button>
  
  <!-- 编辑和删除按钮仅管理员可见 -->
  <template #default="scope">
    <el-button v-if="isAdmin" size="small" link @click="openForm(scope.row)">编辑</el-button>
    <el-button v-if="isAdmin" size="small" link @click="remove(scope.row)">删除</el-button>
  </template>
</template>

<script setup>
import { computed } from 'vue'
import { useAuthStore } from '../store/auth'

const auth = useAuthStore()
const isAdmin = computed(() => auth.user?.role === 'admin')
</script>
```

### 3. 后端权限控制

**当前实现**：
- 后端未显式检查权限
- 前端通过隐藏按钮控制

**改进建议**：
```java
@PostMapping
public ResponseUtil<Service> add(@RequestBody Service service) {
  // 检查是否为管理员
  String role = UserContext.getRole();
  if (!"admin".equalsIgnoreCase(role)) {
    return ResponseUtil.error(403, "无权限新增服务");
  }
  
  service.setCreatedTime(LocalDateTime.now());
  service.setUpdatedTime(LocalDateTime.now());
  serviceManageService.save(service);
  return ResponseUtil.success("新增成功", service);
}
```

---

## 🔍 查询优化

### 1. 查询性能

#### 1.1 分页查询（ServiceView中）

```sql
SELECT * FROM services 
WHERE status = 1 
  AND service_name LIKE '%护理%'
ORDER BY id DESC
LIMIT 10 OFFSET 0;
```

**优化点**：
- ✅ status索引加速状态过滤
- ✅ service_name索引加速名称搜索
- ✅ 分页防止数据过大

#### 1.2 全查询（预约时）

```sql
SELECT * FROM services 
WHERE status = 1
ORDER BY id;
```

**优化点**：
- ✅ status索引加速
- ✅ 直接返回，无分页
- ❌ **改进**：可按type分组返回

### 2. 查询场景

| 场景 | 接口 | 返回数据 | 用途 |
|------|------|---------|------|
| 管理页面 | GET /service | 分页结果 | 列表展示和管理 |
| 预约选择 | GET /service/all | 全部数据 | 下拉列表选项 |
| 获取详情 | GET /service/{id} | 单条记录 | 显示服务详情 |

---

## 📊 实际应用示例

### 示例1：创建一个完整的服务

```
操作：管理员创建"老年康复锻炼"服务

1. 点击"新增"按钮
2. 填写表单：
   - 名称：老年康复锻炼（日常）
   - 类型：康复锻炼
   - 描述：专业的物理治疗和功能恢复锻炼，包括肌肉训练、柔韧性改善等
   - 价格：¥80
   - 时长：60分钟
   - 状态：可用
3. 点击"保存"
4. 系统创建服务，ID=10

后续在预约中：
- 选择该服务时，自动填充价格¥80
- 预约完成时，生成费用记录¥80
```

### 示例2：修改服务价格

```
操作：管理员调整"生活护理"价格

当前：
- 服务1：生活护理基础包，¥50/次
- 预约1-5：已创建，均为¥50

操作：
1. 编辑服务1
2. 修改价格：¥50 → ¥60
3. 保存

结果：
- 预约1-5的费用仍为¥50（已生成）
- 预约6+（新建）的费用为¥60
```

### 示例3：禁用服务

```
操作：管理员暂停某项服务

1. 编辑服务
2. 修改状态：可用 → 禁用
3. 保存

结果：
- 该服务不再显示在预约的服务列表中
- 现有关联预约不受影响
- 后续可重新启用
```

---

## ⚠️ 已知问题与改进方向

### 问题1：无前置校验删除约束
**现状**：删除服务时未检查是否有关联预约  
**风险**：可能删除正在使用的服务，导致数据不一致  
**改进**：
```java
@DeleteMapping("/{id}")
public ResponseUtil<String> delete(@PathVariable Long id) {
  // 检查是否有关联预约
  long count = appointmentService.count(
    new QueryWrapper<Appointment>()
      .eq("service_id", id)
      .in("status", "待确认", "已确认", "进行中")
  );
  
  if (count > 0) {
    return ResponseUtil.error(400, "该服务仍有未完成的预约，无法删除");
  }
  
  serviceManageService.removeById(id);
  return ResponseUtil.success("删除成功");
}
```

### 问题2：无权限校验（后端）
**现状**：后端未验证用户是否为管理员  
**风险**：普通用户可能通过接口直接修改服务  
**改进**：在所有修改接口添加权限检查

### 问题3：无服务类型预定义
**现状**：serviceType为自由文本，可能存在数据重复或不一致  
**改进方案**：
```java
// 定义枚举
public enum ServiceType {
  LIFE_CARE("生活护理"),
  MEDICAL_CARE("医疗护理"),
  PSYCHOLOGICAL("心理关怀"),
  HEALTH_CHECK("健康检查"),
  COMPANION("陪护服务"),
  REHABILITATION("康复锻炼"),
  NUTRITION("营养配餐");
}

// 改为下拉选择
<el-select v-model="form.serviceType">
  <el-option v-for="type in serviceTypes" :key="type.value" :label="type.label" :value="type.value" />
</el-select>
```

### 问题4：价格历史记录
**现状**：修改价格后无历史记录，无法追踪价格变更  
**改进方向**：
- 建立服务价格历史表
- 记录每次价格修改
- 查询时追溯历史价格

### 问题5：服务套餐功能缺失
**现状**：仅支持单个服务，无套餐组合  
**改进方向**：
- 支持服务组合（如"月度护理套餐"）
- 套餐打折支持
- 套餐与单项服务的切换

### 问题6：无图片或详细展示
**现状**：仅文字描述服务  
**改进方向**：
- 添加服务图片
- 富文本描述
- 服务视频演示

### 问题7：无评价关联
**现状**：服务与评价无直接关联  
**改进**：
- 关联服务评价
- 显示平均评分
- 基于评价优化服务

---

## 🧪 测试场景

### 1. 新增服务测试

**场景1.1：正常新增**
```
输入：名称=新服务，价格=100，时长=60，状态=1
期望：服务创建成功，列表显示新服务
```

**场景1.2：名称重复**
```
输入：名称=已存在的服务名称
期望：可以重复，系统不检查（可以改进）
```

**场景1.3：价格为0**
```
输入：价格=0
期望：允许创建（可用于免费服务）
```

### 2. 编辑服务测试

**场景2.1：修改价格**
```
操作：修改现有服务的价格
期望：价格更新，后续预约使用新价格
```

**场景2.2：禁用服务**
```
操作：修改状态为禁用
期望：服务不再显示在选择列表中
```

### 3. 删除服务测试

**场景3.1：删除无关联预约的服务**
```
操作：删除未使用的服务
期望：删除成功
```

**场景3.2：删除有关联预约的服务**
```
操作：删除有未完成预约的服务
期望：应拒绝删除（当前可删除，需改进）
```

### 4. 查询服务测试

**场景4.1：按名称搜索**
```
搜索：输入"护理"
期望：列出所有包含"护理"的服务
```

**场景4.2：预约时查询**
```
操作：创建预约时选择服务
期望：列出所有可用服务，含价格信息
```

---

## 📈 性能与扩展

### 1. 当前性能指标

- **查询速度**：毫秒级（<100ms）
- **列表容量**：支持千级服务项目
- **分页效率**：O(1)

### 2. 性能优化方向

- [ ] 服务数据缓存（Redis）
- [ ] 列表查询加入排序选项
- [ ] 批量导入/导出功能
- [ ] 服务分类树形展示

### 3. 功能扩展方向

- [ ] 服务套餐和组合
- [ ] 按时段定价（高峰/平谷）
- [ ] 批量操作（批量禁用、启用）
- [ ] 服务评价和统计
- [ ] 服务推荐系统
- [ ] 优惠券和折扣系统

---

## 总结

服务项目管理模块是系统的**基础数据管理模块**，为预约和费用计算提供支撑。

✅ **核心价值**：
- 灵活的服务定义和定价
- 简洁的管理界面
- 与预约系统的紧密集成

✅ **关键流程**：
- 管理员创建和维护服务信息
- 预约时选择服务并自动继承价格
- 完成预约时自动生成相应费用

⚠️ **主要改进方向**：
- 删除前验证关联预约
- 后端权限校验
- 服务类型预定义
- 价格历史记录
- 服务套餐功能

该模块虽然功能相对简单，但在整个系统中扮演**数据基础**的重要角色。

