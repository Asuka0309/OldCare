# 模块文件映射-07-社区活动与资讯

> 范围：社区活动（发布/列表/详情/管理/报名） + 资讯（新闻列表，通过后端代理外部 API）。
> 目标：把《模块分析-07-社区活动与资讯.md》中描述的功能，对应到当前代码仓库里的**前端页面/API**与**后端Controller/Service/Mapper/Entity/配置**。

---

## 1. 前端文件（oldcare-system-front）

### 1.1 路由入口
- 路由定义：[oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js)
  - 社区活动页面：`/activities` → `CommunityActivityView.vue`，角色：`admin/resident/caregiver`

### 1.2 社区活动（活动列表/管理/报名）
- 页面：[oldcare-system-front/src/views/CommunityActivityView.vue](oldcare-system-front/src/views/CommunityActivityView.vue)
  - 功能点：
    - 列表分页 + 条件筛选：状态（published/completed/cancelled）、类型、标题关键词
    - 管理员：新建/编辑/完成/取消/删除
    - 非管理员：报名/取消报名
  - 重要实现细节：
    - `registeredActivityIds` 仅在前端内存维护：报名后 push，取消后 filter
    - 页面初始化**未**从后端拉取“我已报名的活动列表”，因此刷新页面后“是否已报名”的按钮状态可能不准确（需要后端提供“我的报名列表”或前端做二次校验）

- API 封装：[oldcare-system-front/src/api/communityActivity.js](oldcare-system-front/src/api/communityActivity.js)
  - `getAllActivities(params)` → `GET /api/activities`
  - `getActivityById(id)` → `GET /api/activities/{id}`
  - `createActivity(data)` → `POST /api/activities`（管理员）
  - `updateActivity(id, data)` → `PUT /api/activities/{id}`（管理员）
  - `deleteActivity(id)` → `DELETE /api/activities/{id}`（管理员）
  - `cancelActivity(id)` → `PUT /api/activities/{id}/cancel`（管理员）
  - `completeActivity(id)` → `PUT /api/activities/{id}/complete`（管理员，前端按管理员显示按钮）
  - `registerActivity(id)` → `POST /api/activities/{id}/register`
  - `unregisterActivity(id)` → `DELETE /api/activities/{id}/register`

### 1.3 资讯（新闻）
- API 封装：[oldcare-system-front/src/api/news.js](oldcare-system-front/src/api/news.js)
  - `getNews()` → `GET /api/news`

- 仪表盘使用（展示“正在进行的活动/今日新闻”）：
  - 页面：[oldcare-system-front/src/views/DashboardView.vue](oldcare-system-front/src/views/DashboardView.vue)
    - 活动：调用 `getAllActivities({ status: 'published', size: 10 })`，前端再过滤 `activityDate >= now && status==='published'`
    - 新闻：调用 `getNews()`，对多种返回结构做兼容解析；失败时使用模拟数据兜底；点击新闻通过 `openNews` 新标签打开 `item.url`

---

## 2. 后端文件（oldcare-system）

### 2.1 社区活动（活动发布/管理/报名）

- Controller：[oldcare-system/src/main/java/com/example/oldcaresystem/controller/CommunityActivityController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/CommunityActivityController.java)
  - 基路径：`/api/activities`

- Entity：
  - 活动：[oldcare-system/src/main/java/com/example/oldcaresystem/entity/CommunityActivity.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/CommunityActivity.java)
  - 报名：[oldcare-system/src/main/java/com/example/oldcaresystem/entity/ActivityRegistration.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/ActivityRegistration.java)

- Service/Impl：
  - 活动：[oldcare-system/src/main/java/com/example/oldcaresystem/service/CommunityActivityService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/CommunityActivityService.java)
  - 活动实现：[oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/CommunityActivityServiceImpl.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/CommunityActivityServiceImpl.java)
  - 报名：[oldcare-system/src/main/java/com/example/oldcaresystem/service/ActivityRegistrationService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/ActivityRegistrationService.java)
  - 报名实现：[oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/ActivityRegistrationServiceImpl.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/impl/ActivityRegistrationServiceImpl.java)

- Mapper：
  - 活动：[oldcare-system/src/main/java/com/example/oldcaresystem/mapper/CommunityActivityMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/CommunityActivityMapper.java)
  - 报名：[oldcare-system/src/main/java/com/example/oldcaresystem/mapper/ActivityRegistrationMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/ActivityRegistrationMapper.java)

### 2.2 资讯（新闻代理）

- Controller：[oldcare-system/src/main/java/com/example/oldcaresystem/controller/NewsController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/NewsController.java)
  - 基路径：`/api/news`
  - 作用：后端代理外部新闻 API（聚合数据头条），避免前端直连产生 CORS/Key 泄露问题

- 配置：[oldcare-system/src/main/resources/application.properties](oldcare-system/src/main/resources/application.properties)
  - `news.api.url`（默认 `http://v.juhe.cn/toutiao/index`）
  - `news.api.key`（新闻 API Key）

---

## 3. 接口映射（前端调用 ↔ 后端实现）

### 3.1 活动列表/详情
- `GET /api/activities`
  - 前端：`getAllActivities(params)`
  - 后端：`CommunityActivityController.list(page,size,status,type,keyword)`
  - 参数：
    - `page`（默认 1）
    - `size`（默认 10）
    - `status`（可选）
    - `type`（可选，对应 `activity_type`）
    - `keyword`（可选，模糊匹配 `activity_title`）
  - 重要逻辑：
    - 非管理员：未传 `status` 时默认只返回 `published`
    - 每条记录都会动态计算 `currentParticipants = countByActivityId(activityId)`（只统计 `registration_status='registered'`）

- `GET /api/activities/{id}`
  - 前端：`getActivityById(id)`（当前页面主要用列表行数据直接展示详情，也可用该接口获取更准的报名人数）
  - 后端：`CommunityActivityController.getById(id)`（同样会计算 `currentParticipants`）

### 3.2 活动发布/编辑/状态变更（管理员）
- `POST /api/activities`
  - 前端：`createActivity(data)`
  - 后端：`CommunityActivityController.create(activity)`
  - 重要逻辑：
    - 后端写入：`organizerId = UserContext.getUserId()`
    - 后端强制：`status = 'published'`

- `PUT /api/activities/{id}`
  - 前端：`updateActivity(id, data)`（页面仅在 `status==='published'` 时显示“编辑”）
  - 后端：`CommunityActivityController.update(id, activity)`（当前未强制校验只能修改 published）

- `PUT /api/activities/{id}/cancel`
  - 前端：`cancelActivity(id)`（页面仅在 `published` 显示）
  - 后端：`CommunityActivityController.cancel(id)`
  - 权限：后端显式要求 `ADMIN`
  - 限制：已完成（`completed`）不可取消

- `PUT /api/activities/{id}/complete`
  - 前端：`completeActivity(id)`（页面仅管理员可见）
  - 后端：`CommunityActivityController.complete(id)`
  - 注意：该接口后端当前未显式校验 `ADMIN`（与前端按钮控制存在“前端限制但后端未限制”的潜在差异）

- `DELETE /api/activities/{id}`
  - 前端：`deleteActivity(id)`
  - 后端：`CommunityActivityController.delete(id)`（物理删除）
  - 权限：后端显式要求 `ADMIN`

### 3.3 活动报名/取消报名
- `POST /api/activities/{id}/register`
  - 前端：`registerActivity(id)`
  - 后端：`CommunityActivityController.register(id)`
  - 校验：
    - 活动必须存在且 `status == 'published'`
    - 不可重复报名：`registrationService.isRegistered(activityId, userId)`
    - 不可超限：`countByActivityId < maxParticipants`
  - 写入：`ActivityRegistration`（`registration_status='registered'`）

- `DELETE /api/activities/{id}/register`
  - 前端：`unregisterActivity(id)`
  - 后端：`CommunityActivityController.unregister(id)`
  - 逻辑：不物理删除报名记录，而是把 `registration_status` 更新为 `cancelled`

---

## 4. 数据表与SQL（db/oldcare_system.sql）

- 活动表：`community_activities`
  - 字段关键点：
    - `admin_id`（SQL命名；代码里对应 `organizerId`）
    - `activity_title/activity_description/activity_type/activity_date/location/max_participants/status`

- 资讯表：`community_news`
  - 当前代码实现的“资讯/新闻”走的是 `/api/news` **外部代理**，并未实现 `community_news` 的 CRUD（该表目前更像为“自建资讯”预留）

- 报名表：建议核对是否存在（SQL片段未在本文件段落中展示；报名功能依赖 `activity_registrations` 或同义表）
  - 代码侧字段：`activity_id/resident_id/registration_status/created_time/updated_time`

---

## 5. 联调/差异点提示（建议关注）

- “是否已报名”状态：前端 `registeredActivityIds` 仅本地维护，刷新后会丢失；如果需要准确展示，后端需提供“我的报名列表/是否报名”接口或前端在拉列表后逐条校验。
- `/complete` 权限：前端按管理员显示按钮，但后端 `PUT /api/activities/{id}/complete` 当前未显式校验管理员。
- 活动类型枚举：SQL 注释里写了 `education/interest/festival/other`，但前端实际使用 `lecture/fitness/entertainment/exchange/other`，后端是字符串透传（需要统一枚举语义）。
- 新闻接口返回结构：前端 Dashboard 对聚合数据多种返回结构做了兼容；后端返回的是 `ApiResponse.success(newsData)`（即把第三方响应整体放在 `data` 中），前端解析时要注意这一层封装。
