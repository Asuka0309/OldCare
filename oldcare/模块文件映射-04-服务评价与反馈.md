# 服务评价与反馈模块 - 前后端文件映射清单

> 本清单聚焦“评价创建/编辑/删除、投诉筛选、按角色数据隔离（居民/护工/管理员）”等联调入口与代码位置。

---

## 前端文件（Vue 3 + Vite）

- 评价与反馈页面（列表/筛选/新增/编辑/删除）： [oldcare-system-front/src/views/EvaluationView.vue](oldcare-system-front/src/views/EvaluationView.vue)
- 评价 API 封装： [oldcare-system-front/src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)

### 页面依赖的引用数据（用于下拉与显示）

- 预约 API（加载“已完成”预约供评价选择）： [oldcare-system-front/src/api/appointment.js](oldcare-system-front/src/api/appointment.js)
- 服务列表（用于把 serviceId 显示成服务名）： [oldcare-system-front/src/api/service.js](oldcare-system-front/src/api/service.js)
- 老人列表（用于 residentId 显示姓名、兼容旧数据）： [oldcare-system-front/src/api/elderly.js](oldcare-system-front/src/api/elderly.js)
- 用户列表（用于 residentId 显示姓名、兼容新数据 users.id）： [oldcare-system-front/src/api/user.js](oldcare-system-front/src/api/user.js)

### 通用依赖（鉴权与路由）

- HTTP 基址与 Token 注入（`baseURL=/api`）： [oldcare-system-front/src/api/http.js](oldcare-system-front/src/api/http.js)
- 登录态存储（sessionStorage）： [oldcare-system-front/src/store/auth.js](oldcare-system-front/src/store/auth.js)
- 路由与角色守卫（含 `/evaluations` 路由）： [oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js)

---

## 后端文件（Spring Boot + MyBatis-Plus）

- 评价控制器（接口入口 + 权限/数据隔离）： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)
- 评价 Service： [oldcare-system/src/main/java/com/example/oldcaresystem/service/EvaluationService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/EvaluationService.java)
- 评价实体（映射 evaluations 表）： [oldcare-system/src/main/java/com/example/oldcaresystem/entity/Evaluation.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Evaluation.java)
- 评价 Mapper： [oldcare-system/src/main/java/com/example/oldcaresystem/mapper/EvaluationMapper.java](oldcare-system/src/main/java/com/example/oldcaresystem/mapper/EvaluationMapper.java)

### 关联模块（创建评价时强依赖）

- 预约（校验存在/状态=已完成/ providerId 匹配）：
  - 预约控制器： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AppointmentController.java)
  - 预约实体： [oldcare-system/src/main/java/com/example/oldcaresystem/entity/Appointment.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Appointment.java)
- 老人信息（通过 appointment.elderlyId → elderly_info.user_id 做“是否本人预约”校验）：
  - 老人控制器： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/ElderlyInfoController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/ElderlyInfoController.java)
  - 老人实体： [oldcare-system/src/main/java/com/example/oldcaresystem/entity/ElderlyInfo.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/ElderlyInfo.java)

### 鉴权

- 用户上下文（取 role/userId）： [oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java](oldcare-system/src/main/java/com/example/oldcaresystem/security/UserContext.java)
- 安全规则： [oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java](oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java)

---

## 接口清单（路径映射）

> 前端 `http.js` 的 `baseURL` 是 `/api`。

- 分页查询评价：`GET /api/evaluation?current=1&size=10&appointmentId=&providerId=&isComplaint=`
  - 前端： [oldcare-system-front/src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)（`list`）
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 查询单个评价：`GET /api/evaluation/{id}`

- 创建评价（仅居民，且仅自己的已完成预约）：`POST /api/evaluation`
  - 前端： [oldcare-system-front/src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)（`add`） + [oldcare-system-front/src/views/EvaluationView.vue](oldcare-system-front/src/views/EvaluationView.vue)
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 修改评价（仅居民，且仅自己的评价）：`PUT /api/evaluation/{id}`
  - 前端： [oldcare-system-front/src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)（`update`）
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 删除评价（管理员可删所有；居民只能删自己的；护工禁止）：`DELETE /api/evaluation/{id}`
  - 前端： [oldcare-system-front/src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)（`delete`）
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 查询投诉列表：`GET /api/evaluation/complaints?current=1&size=10`
  - 前端： [oldcare-system-front/src/api/evaluation.js](oldcare-system-front/src/api/evaluation.js)（`getComplaints`）
  - 后端： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 查询护工/服务商的评价：`GET /api/evaluation/provider/{providerId}?current=1&size=10`

---

## 关键逻辑位置（权限/数据隔离/投诉）

- 创建评价的关键校验：
  - 必须关联预约；预约必须已完成；仅居民；仅自己的预约；providerId 必须等于 appointment.caregiverId
  - 代码入口： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 评价列表数据隔离（居民只看自己的评价）：
  - 逻辑：根据当前 userId 查 elderly_info 列表，组合 `users.id + elderly_info.id` 的可能 resident_id 集合进行 `in` 过滤
  - 代码入口： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

- 投诉筛选：
  - 接口：`/api/evaluation/complaints`（固定 `is_complaint=true`）或列表接口带 `isComplaint` 参数
  - 代码入口： [oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/EvaluationController.java)

---

## 数据库表

- SQL 脚本（包含 evaluations 表结构）： [oldcare-system/src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)

---

## 备注（联调常见点）

- 前端 `EvaluationView.vue` 里为了兼容“residentId 可能是 elderly_info.id 或 users.id”，会同时加载老人列表与用户列表来回填姓名显示。
- 后端 `GET /api/evaluation` 的注释写“管理员和护工可以看到所有评价”，但目前实现只对 resident 做了过滤；若后续需要“护工仅看自己的评价”，需要在后端再按 caregiver 角色增加 provider_id 过滤。