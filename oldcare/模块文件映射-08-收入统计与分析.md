# 模块文件映射-08-收入统计与分析

> 范围：收入统计（周期聚合 + 趋势折线图）。
> 口径：仅统计费用记录 `fee_records.status = '已支付'`，时间维度使用 `payment_time`。
> 角色：管理员（全局）+ 护工（仅个人）；居民访问后端接口会返回 403。

---

## 1. 前端文件（oldcare-system-front）

### 1.1 路由入口
- 路由定义：[oldcare-system-front/src/router/index.js](oldcare-system-front/src/router/index.js)
  - 收入统计页面：`/income` → `IncomeView.vue`
  - 允许角色：`admin`、`caregiver`

### 1.2 页面实现
- 页面：[oldcare-system-front/src/views/IncomeView.vue](oldcare-system-front/src/views/IncomeView.vue)
  - 周期选择：`today/week/month/year`（默认 `month`）
  - 统计卡片：总收入、交易笔数、统计周期
  - 图表：`vue-echarts` 折线图（标题根据角色显示“总收入趋势/我的收入趋势”）
  - 数据加载：`load()` 调用 `getIncomeStatistics(period)`
  - 空数据提示：若 `chartData.length === 0` 显示“暂无数据”

### 1.3 API 封装
- API：[oldcare-system-front/src/api/income.js](oldcare-system-front/src/api/income.js)
  - `getIncomeStatistics(period)` → `GET /api/income/statistics?period=...`
  - 备注：该文件使用 `http.get('income/statistics', ...)`；由于 `http` 的 `baseURL='/api'`，最终请求仍为 `/api/income/statistics`

---

## 2. 后端文件（oldcare-system）

### 2.1 Controller
- 收入统计控制器：[oldcare-system/src/main/java/com/example/oldcaresystem/controller/IncomeController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/IncomeController.java)
  - 基路径：`/api/income`
  - 接口：`GET /api/income/statistics`

### 2.2 依赖的实体/服务
- 费用记录：
  - 实体：[oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java)
  - 服务：[oldcare-system/src/main/java/com/example/oldcaresystem/service/FeeRecordService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/FeeRecordService.java)
  - 控制器（数据源相关的支付/退款状态由这里维护）：[oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeeRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeeRecordController.java)

- 预约（用于护工视角过滤）：
  - 实体：[oldcare-system/src/main/java/com/example/oldcaresystem/entity/Appointment.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Appointment.java)
  - 服务：[oldcare-system/src/main/java/com/example/oldcaresystem/service/AppointmentService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/AppointmentService.java)

- 护工（用户映射到 caregiver）：
  - 实体：[oldcare-system/src/main/java/com/example/oldcaresystem/entity/Caregiver.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Caregiver.java)
  - 服务：[oldcare-system/src/main/java/com/example/oldcaresystem/service/CaregiverService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/CaregiverService.java)

---

## 3. 接口映射（前端调用 ↔ 后端实现）

### 3.1 获取收入统计
- 请求：`GET /api/income/statistics`
  - 参数：`period` 可选，取值 `today|week|month|year`（为空默认 `month`）
  - 前端：`getIncomeStatistics(period)`
  - 后端：`IncomeController.getStatistics(period)`

### 3.2 权限与数据隔离
- 后端权限：
  - 非 `admin` 且非 `caregiver`：返回 `ApiResponse.error(403, "无权限查看收入统计")`

- 护工隔离逻辑（后端）：
  1) 通过 `caregivers.user_id = 当前 userId` 查询护工记录
  2) 查询该护工的预约：`appointments.provider_id = caregiver.id` 且 `appointments.status = '已完成'`
  3) 取预约 id 列表，追加到费用查询条件：`fee_records.appointment_id IN (...)`

- 管理员视角：
  - 不加护工过滤，直接统计范围内所有“已支付”费用

### 3.3 统计口径（后端）
- 基础筛选：
  - `fee_records.status = '已支付'`
  - `fee_records.payment_time BETWEEN startDateTime AND now`

- 总额与笔数：
  - `totalAmount`：把查询到的 `FeeRecord.amount` 累加（`BigDecimal`）
  - `totalCount`：记录条数（`records.size()`）

- 趋势图数据：
  - 先按 `payment_time.toLocalDate()` 聚合到 `Map<date, amount>`
  - 再从 `startDate` 循环到 `LocalDate.now()`，逐日补点（无收入补 `0`）生成 `chartData: [{date, amount}]`

---

## 4. 周期起点计算（后端实现口径）

- `today`：当天
- `week`：`now.minusWeeks(1)`（注意：这是“往前推 1 周”的起点，通常会覆盖 8 天左右的数据点：含起点日与今天）
- `month`：当月 1 号
- `year`：当年 1 月 1 号
- 其它/非法值：回退到 `month`

---

## 5. 数据表与字段（db/oldcare_system.sql）

- 费用表：`fee_records`
  - 核心字段：`amount/status/payment_time/appointment_id`
  - SQL 注释里的状态：`未支付、已支付、已退款`
  - 代码里额外使用的状态：`退款申请中`（见 FeeRecordController 的退款流程）；收入统计只统计 `已支付`

- 预约表：`appointments`
  - 核心字段：`id/provider_id/status`

- 护工表：`caregivers`
  - 核心字段：`id/user_id`

---

## 6. 与分析文档的差异/联调点（建议关注）

- 空数据时的 chartData：
  - 后端在“护工没有对应 caregiver / 没有已完成预约”时，直接返回 `chartData = []`（不做补零）；前端会展示“暂无数据”。
  - 如果希望“无收入也显示一条连续的 0 趋势线”，需要后端在空数据也按日期范围补零（或前端自行补零）。

- provider_id 语义：
  - 后端统计逻辑假定 `appointments.provider_id = caregivers.id`（护工表主键）。
  - SQL dump 中 `appointments.provider_id` 的外键指向 `users(id)`，但示例数据（provider_id=1/5/6/7…）更像在用 `caregivers.id`。
  - 这属于历史数据/约束不一致点：统计模块依赖“provider_id=caregivers.id”的口径。

---

## 7. 小结（文件到功能的对应）

- 页面与可视化：
  - [oldcare-system-front/src/views/IncomeView.vue](oldcare-system-front/src/views/IncomeView.vue)

- 前端接口封装：
  - [oldcare-system-front/src/api/income.js](oldcare-system-front/src/api/income.js)

- 后端统计入口：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/IncomeController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/IncomeController.java)

- 数据来源与口径控制：
  - [oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeeRecordController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/FeeRecordController.java)
  - [oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java)
