# 模块分析 02 - 服务项目管理（答辩速学稿）

面向答辩快速掌握服务项目的增删改查操作：理解核心数据字段、CRUD 接口的业务规则、防删策略、前端表单与列表交互、权限控制。

## 1. 快速索引（必看文件）
- 后端实体：[src/main/java/com/example/oldcaresystem/entity/Service.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/Service.java)
- 后端控制器：[src/main/java/com/example/oldcaresystem/controller/ServiceController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/ServiceController.java)
- 后端服务：[src/main/java/com/example/oldcaresystem/service/ServiceManageService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/ServiceManageService.java)
- 前端 API：[src/api/service.js](oldcare-system-front/src/api/service.js)
- 前端页面：[src/views/ServiceView.vue](oldcare-system-front/src/views/ServiceView.vue)
- 数据库关联：appointments.service_id 外键指向 services.id，删除需防止外键约束

## 2. 数据模型与表
- 表 `services`：
  - id：主键自增
  - service_name：服务项目名称（如"生活护理"、"医疗护理"等）
  - service_type：服务类型（如"生活护理"、"医疗护理"、"心理关怀"、"健康检查"等）
  - description：服务详细描述
  - price：服务价格（BigDecimal，精确到分）
  - duration_minutes：服务时长（分钟）
  - status：状态（1=可用，0=禁用）
  - created_time / updated_time：创建/更新时间

## 3. 后端接口详解

### 3.1 新增服务项目
```
POST /api/service
权限：仅 admin（后续可按需添加角色校验）
请求体：{ serviceName, serviceType, description, price, durationMinutes }

业务规则：
- serviceName 必填，长度限制建议 1-100 字符
- serviceType 必填，对应预定义的服务类型
- price 必填，必须 > 0
- durationMinutes 必填，必须 > 0
- 状态自动初始化为 status=1（可用）
- created_time / updated_time 自动设置为当前时间

返回：201 Created，返回新建的 Service 对象
```

### 3.2 更新服务项目
```
PUT /api/service
权限：仅 admin
请求体：{ id, serviceName, serviceType, description, price, durationMinutes }

业务规则：
- id 必填，必须指向一条存在的服务
- 可更新任意字段
- updated_time 自动设置为当前时间
- 不能通过此接口改 status（改状态需通过禁用接口或其他方式）

返回：200 OK，返回更新后的 Service 对象
```

### 3.3 删除服务项目（防删策略）
```
DELETE /api/service/{id}
权限：仅 admin
请求体：无

前置检查：
- 检查是否存在关联预约（QueryWrapper where service_id = id）
- 如果 refCount > 0：
  - 将 status 改为 0（禁用）
  - updated_time = 当前时间
  - 返回错误信息："该服务已有预约，已自动禁用，无法删除。"
  - 这样保护了历史预约数据的完整性
- 如果 refCount = 0：
  - 直接 removeById(id)，物理删除

返回：200 OK
- 成功删除："删除成功"
- 防删禁用："该服务已有预约，已自动禁用，无法删除。"
```
**设计思想**：appointments 与 services 有外键约束，直接删除会违反约束；采用"先禁用再删除"策略，既保护数据完整性，又防止操作冲突。

### 3.4 查询单个服务项目
```
GET /api/service/{id}
权限：无限制（前端需在导航中隐藏）
请求体：无

业务规则：
- 按 id 直接查询
- 无论 status 为 0 还是 1 都返回（用于查看禁用的服务详情）

返回：200 OK，返回 Service 对象
```

### 3.5 分页查询服务列表
```
GET /api/service
权限：无限制
查询参数：current（页码，默认 1）、size（每页数，默认 10）、serviceName（可选，模糊搜索）

业务规则：
- 只返回 status=1 的可用服务（禁用的服务对用户隐藏）
- serviceName 模糊匹配（like 查询）
- 支持分页，返回 Page 对象

返回：200 OK
{
  records: [Service 对象数组],
  total: 总数,
  current: 当前页码,
  size: 每页大小,
  pages: 总页数
}
```

### 3.6 查询所有可用服务（不分页）
```
GET /api/service/all
权限：无限制
查询参数：无

业务规则：
- 返回所有 status=1 的服务（用于下拉菜单选项）
- 不分页，返回列表
- 无模糊搜索

返回：200 OK，返回 Service 对象数组
```

## 4. 前端交互与流程

### 4.1 服务列表（ServiceView.vue）
- **搜索与筛选：**
  - 服务名称输入框（支持模糊搜索）
  - 搜索按钮或回车触发 fetchServices
  
- **表格展示：**
  - 列：ID、服务名、服务类型、价格、时长（分钟）、状态（Tag）、创建时间、操作
  - 状态 Tag：status=1 显示"可用"（绿色），status=0 显示"禁用"（灰色）
  
- **分页控制：**
  - 分页器：显示 total、当前页、每页条数，支持快速跳转
  
- **操作按钮：**
  - 编辑（edit）：点击打开表单对话框，回显数据
  - 删除（delete）：点击确认对话框后调用 deleteService(id)
    - 若后端返回"已自动禁用"，需刷新列表查看状态变化
    - 若后端返回"删除成功"，则从列表移除

### 4.2 新增/编辑对话框
- **触发方式：**
  - 新增：点击"新增服务"按钮，打开空表单
  - 编辑：点击"编辑"按钮，打开表单并回显数据
  
- **表单字段及校验：**
  - 服务名（serviceName）：必填，文本输入
  - 服务类型（serviceType）：必填，下拉选择（预定义列表）
  - 描述（description）：必填，多行文本
  - 价格（price）：必填，数字输入，min=0.01，step=10
  - 时长（durationMinutes）：必填，数字输入，min=1
  
- **提交逻辑：**
  - 新增：调用 createService(formData)
  - 编辑：调用 updateService(formData)
  - 成功后关闭对话框并刷新列表
  - 异常时显示错误提示

## 5. 权限与角色

| 操作 | Admin | Caregiver | Resident |
|------|-------|-----------|----------|
| 新增服务 | ✓ | ✗ | ✗ |
| 编辑服务 | ✓ | ✗ | ✗ |
| 删除服务 | ✓ | ✗ | ✗ |
| 查询单个 | ✓ | ✓ | ✓ |
| 分页列表 | ✓ | ✓ | ✓ |
| 全量列表（下拉） | ✓ | ✓ | ✓ |

## 6. 答辩常见问答（含实现思路）

**Q: 删除服务为什么会"自动禁用"而不是硬删？**
A: appointments 表对 services 有外键约束。若直接删除有预约的服务，会触发外键冲突。采用"软删禁用"策略：先检查关联预约数量，若>0 则改 status=0 防止外键异常，同时保护历史预约/评价数据的完整性；若无预约才能硬删。

**Q: 如何限制价格与时长的范围？**
A: 后端在 save/updateById 前校验 price>0 && durationMinutes>0，否则返回 400 Bad Request；前端使用 el-input-number 组件并设 :min 和 :step 属性，双重校验。

**Q: 怎样实现按服务类型过滤？**
A: 在后端 GET /api/service 接口增加 serviceType 参数，QueryWrapper 加 .eq("service_type", serviceType)；前端增加类型下拉筛选器，选择后调用 fetchServices 传参。

**Q: 禁用后的服务对用户可见吗？**
A: 分页查询 GET /api/service 只返回 status=1 的服务，禁用（status=0）对普通用户隐藏。只有通过查询单个接口（/api/service/{id}）且知道 id 才能看到禁用服务的信息（通常用于后台管理或查看历史预约）。

**Q: 如何在预约时校验服务是否可用？**
A: 在预约接口中，关联服务前调用 serviceManageService.getById(serviceId)，检查 status==1 且 price>0 && durationMinutes>0；若校验失败返回 400 "服务不可用"。

**Q: 能否支持批量删除服务？**
A: 当前接口为单个删除。若要批量，可增加 POST /api/service/batch-delete 接口，接收 List<Long> ids，对每个 id 执行同样的防删逻辑，返回成功与失败列表。

**Q: 价格或时长改为 0 会怎样？**
A: 后端校验 price>0 && durationMinutes>0，若改为 ≤0 返回 400；前端表单也用 el-input-number 设 min=0.01（price）和 min=1（时长）防止输入。

**Q: 服务删除后，其历史预约还能访问吗？**
A: 可以。预约记录中保存了当时的 service_name、price、durationMinutes 等冗余字段；即使删除了服务记录，预约数据仍完整，用户可查看历史交易。

**Q: 如何支持多国语言的服务类型列表？**
A: 可将服务类型抽象为单独的 ServiceType 表或枚举 + i18n 国际化配置；后端返回类型代码，前端根据语言配置展示对应文案。

## 7. 改进建议（答辩加分点）
- **完整的输入校验**：后端增加 @Valid 与自定义注解，校验字段长度、范围、格式；数据库为 service_name 增加唯一索引防止重复。
- **操作日志**：记录所有增改删操作的用户、时间、变更字段，支持审计与数据恢复。
- **状态管理精细化**：可扩展 status 为 0=禁用、1=可用、2=待审批、3=已下架，配合审批流程。
- **缓存优化**：getAll 接口结果可缓存（如 Redis），避免高频数据库查询；禁用/启用时实时清缓存。
- **软删设计**：不直接删除，改为 is_deleted=1 + deleted_time 字段，支持恢复；查询时默认过滤 is_deleted=0。
- **关联查询增强**：返回服务时附带相关信息（如该服务的预约数、评价数、平均评分），便于运营分析。
