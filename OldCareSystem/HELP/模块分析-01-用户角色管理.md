# 模块分析 01 - 用户与角色管理（答辩速学稿）

面向新手快速搞懂用户与角色模块，目标：在答辩能说清数据模型、登录注册流程、JWT 安全链路、前端路由守卫与管理界面，并能回答改进点。

## 1. 快速索引（需优先阅读的文件）
- 后端实体与表： [src/main/java/com/example/oldcaresystem/entity/User.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/User.java)、[src/main/resources/db/oldcare_system.sql](oldcare-system/src/main/resources/db/oldcare_system.sql)
- 认证与用户接口： [controller/AuthController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/AuthController.java)、[controller/UserController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/UserController.java)、[service/UserService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/UserService.java)、[dto/LoginRequest.java](oldcare-system/src/main/java/com/example/oldcaresystem/dto/LoginRequest.java)、[util/JwtUtil.java](oldcare-system/src/main/java/com/example/oldcaresystem/util/JwtUtil.java)
- 安全配置： [config/SecurityConfig.java](oldcare-system/src/main/java/com/example/oldcaresystem/config/SecurityConfig.java)、[security/JwtAuthenticationFilter.java](oldcare-system/src/main/java/com/example/oldcaresystem/security/JwtAuthenticationFilter.java)、[application.properties](oldcare-system/src/main/resources/application.properties)
- 前端交互： [src/api/auth.js](oldcare-system-front/src/api/auth.js)、[src/api/user.js](oldcare-system-front/src/api/user.js)、[store/auth.js](oldcare-system-front/src/store/auth.js)、[router/index.js](oldcare-system-front/src/router/index.js)、[views/LoginView.vue](oldcare-system-front/src/views/LoginView.vue)、[views/RegisterView.vue](oldcare-system-front/src/views/RegisterView.vue)、[views/UserView.vue](oldcare-system-front/src/views/UserView.vue)

## 2. 数据模型与表
- `users` 表（见 SQL）：字段含 username 唯一、password (MD5)、real_name、phone、email、avatar、role (枚举：admin/resident/caregiver/service_provider)、status (1 启用/0 停用)、创建与更新时间。
- 角色没有单独表，直接存字符串；部分角色在注册时自动在 caregives/elderly_info/service_provider_info 表落关联记录。

## 3. 认证与注册流程（后端）
- 登录：`AuthController` 接收 `LoginRequest`（username、password），`UserService.login` 按用户名查库，MD5 比对密码，生成含 id/username/role 的 JWT，返回 `LoginResponse`。
- 注册：`UserController.register` 接收用户基本信息与角色，MD5 存储密码，写入 `users`，根据角色可同步创建对应角色表记录。
- 密码哈希：使用 `MD5Util`，无盐；可改进为 BCrypt。
- JWT：`JwtUtil` 使用配置的 secret 和过期时间生成/解析；无刷新令牌机制。

## 4. 安全链路（Spring Security）
- `SecurityConfig`：配置无状态会话，放行登录注册、静态资源与部分公共接口，其余需认证。
- `JwtAuthenticationFilter`：从 Authorization: Bearer 解析 token，校验后将用户放入 SecurityContext；未设置角色权限集合，因此后端未做基于角色的鉴权。
- `JwtAuthenticationEntryPoint`：认证失败返回 401 JSON。

## 5. 用户管理接口
- `UserController`：分页查询、创建、更新、删除用户；`changeStatus` 切换启停；`register` 复用注册逻辑。
- `UserService`：封装登录、注册、默认用户初始化、按角色派生记录创建。
- `UserMapper`：MyBatis-Plus 持久化访问。

## 6. 前端交互与路由守卫
- API 封装：`auth.js` 登录/注册；`user.js` 用户 CRUD 与状态切换；`http.js` 统一注入 Bearer token。
- 状态管理：`store/auth.js` 用 Pinia 存 token/user，持久化 sessionStorage。
- 路由守卫：`router/index.js` 全局 beforeEach，若无 token 重定向登录；根据 meta.roles 做客户端角色校验（仅前端校验）。
- 页面：`LoginView` 登录表单；`RegisterView` 角色选择注册；`UserView`（管理员界面）列表、搜索、增改删、停用启用，角色选项 admin/caregiver/elderly_family/system。

## 7. 答辩常见问答清单（示例回答思路）
- 问：角色是如何存储和使用的？
  - 答：角色直接存于 users.role 字符串，无单独角色表；登录时写入 JWT，前端路由守卫基于该值控制可见路由；后端目前未做角色鉴权，只做认证。
- 问：为什么用 JWT？
  - 答：前后端分离，JWT 便于无状态认证；客户端存储 token，后端通过过滤器校验，无需 session。
- 问：密码如何保护？
  - 答：当前用 MD5 存储，无盐；可改进为 BCrypt 加盐并增加复杂度校验。
- 问：后端有做权限控制吗？
  - 答：仅做认证；`JwtAuthenticationFilter` 验证 token，但未基于角色拦截。改进可在 SecurityConfig 中为接口配置 `hasRole(...)` 或使用注解 `@PreAuthorize`。
- 问：token 过期或无效会怎样？
  - 答：过滤器校验失败走 `JwtAuthenticationEntryPoint` 返回 401，前端路由守卫无 token 会重定向登录；目前无刷新机制，需重新登录。
- 问：前端如何阻止无权访问？
  - 答：路由 meta.roles + 全局守卫；但这是客户端校验，需配合后端鉴权才能真正防护。
- 问：注册时如何保证数据一致？
  - 答：注册接口在创建用户后根据角色同步在角色对应表中建关联记录（如 caregiver_info），保持角色数据一致。
- 问：如果要新增角色/权限怎么做？
  - 答：需扩展 users.role 取值并同步前端路由 meta；更好的方案是新增角色、权限表，后端基于角色/权限做鉴权，前端基于权限点控制 UI。
- 问：怎么实现后端基于角色的接口权限？
  - 答：在 SecurityConfig 中为受保护接口配置 hasRole/hasAuthority；在 JwtAuthenticationFilter 把用户权限集合放入 Authentication；在控制器上用 @PreAuthorize("hasRole('admin')") 精确控制。
- 问：怎么让密码更安全？
  - 答：改用 BCryptPasswordEncoder 保存和校验密码，增加密码复杂度校验与错误次数限制；迁移时可逐步把旧 MD5 用户在下次登录时重算为 BCrypt。
- 问：怎么实现刷新令牌？
  - 答：颁发短期访问令牌 + 长期刷新令牌；新增 /auth/refresh 接口校验刷新令牌后重新生成访问令牌，并在数据库/缓存存储刷新令牌白名单与失效时间。
- 问：怎么实现用户停用后立即失效？
  - 答：后端在 changeStatus 后清理该用户的活跃 token（如在 Redis 记录黑名单或提升 token 版本号）；在 JwtAuthenticationFilter 校验时比对版本/黑名单，命中则拒绝。
- 问：怎么在前端隐藏无权限的菜单与按钮？
  - 答：在获取用户信息时返回权限点数组；路由 meta 结合权限点过滤菜单；组件内通过 v-if 判断 store 中的权限集合决定按钮显隐。
- 问：怎么新增一个“审核员”角色并限制仅能查看不可编辑？
  - 答：后端：在角色枚举中加入 reviewer，给查询接口放行或 hasRole('reviewer')，编辑接口限制 hasRole('admin')；前端：路由 meta 增加 reviewer，列表页面按钮根据角色或权限点隐藏编辑/删除。

## 8. 改进建议（可作为答辩补充）
- 密码与安全：使用 BCrypt 替换 MD5，增加密码复杂度校验与登录失败次数限制；引入刷新令牌。
- 权限控制：在后端按接口设置角色或权限校验（`hasRole/hasAuthority`），并在 JWT 中写入权限集合。
- 角色模型：引入 role/permission 表，实现多角色与细粒度权限；统一前后端权限点。
- 审计与日志：记录登录失败、状态切换、增删改操作日志，便于追溯。
