# 模块分析 08 - 收入统计与分析（答辩速学稿）

面向答辩快速掌握收入统计与分析功能：理解按周期聚合费用数据、角色权限区分（管理员全局查看 vs 护工自查收入）、日级分组统计、ECharts 线图展示。

## 1. 快速索引（必看文件）
- 后端收入统计控制器：[src/main/java/com/example/oldcaresystem/controller/IncomeController.java](oldcare-system/src/main/java/com/example/oldcaresystem/controller/IncomeController.java)
- 后端费用实体：[src/main/java/com/example/oldcaresystem/entity/FeeRecord.java](oldcare-system/src/main/java/com/example/oldcaresystem/entity/FeeRecord.java)
- 后端费用服务：[src/main/java/com/example/oldcaresystem/service/FeeRecordService.java](oldcare-system/src/main/java/com/example/oldcaresystem/service/FeeRecordService.java)
- 前端 API 封装：[src/api/income.js](oldcare-system-front/src/api/income.js)
- 前端页面：[src/views/IncomeView.vue](oldcare-system-front/src/views/IncomeView.vue)

## 2. 数据模型与表
- `fee_records`：appointment_id、resident_id（新数据）/ elderlyId（旧数据，elderly_info.id）、service_name、amount、fee_type（service/materials/other）、status（未支付/已支付/退款申请中/已退款）、payment_time、created_time/updated_time。
- 收入统计数据来源：查询 status='已支付' 的 fee_records，按 payment_time 过滤与分组。
- 关联关系：fee_records.appointment_id → appointments.id；fee_records.resident_id → users.id（新） / elderly_info.id（旧）。

## 3. 后端接口与业务流程
- 获取统计 GET /api/income/statistics：
  - 参数：period（today/week/month/year），默认 month。
  - 权限：admin（管理员查看全局收入）或 caregiver（护工查看自己的收入）；其他角色（resident）返回 403。
  - 业务逻辑：
    - 通过 UserContext 获取当前用户角色与 userId。
    - 如果为 admin：无条件限制，统计所有用户的已支付费用。
    - 如果为 caregiver：先查询 caregiver 表获取当前护工对应的 caregiver.id，再查询 appointments 表中 provider_id 匹配的预约（兼容新旧字段：provider_id=caregiver.userId 或 provider_id=caregiver.id），最后统计这些预约对应的已支付费用。
  - 日期范围计算：
    - today：当日。
    - week：过去 7 天（包括今日）。
    - month：从本月 1 日至今日。
    - year：从本年 1 月 1 日至今日。
  - 查询条件：status='已支付' 且 payment_time 在日期范围内。
  - 返回数据：
    - totalAmount：总收入（BigDecimal）。
    - totalCount：交易笔数（int）。
    - period：统计周期（string）。
    - startDate/endDate：日期范围（LocalDate 转字符串）。
    - chartData：按日期分组的日收入数据，格式 [{ date: "2026-01-01", amount: 150.00 }, ...]。
  - 图表数据生成：从 startDate 到今日，逐日迭代，若该日无费用则填充 amount=0（保证曲线完整性）。
  - 异常处理：caregiver 若无对应记录或无预约返回空统计（totalAmount=0, totalCount=0, chartData=[]）。

## 4. 前端交互与流程
- IncomeView.vue（收入统计页）：
  - 周期选择器：下拉菜单（today/week/month/year），默认 month。
  - 统计卡片（3 张）：总收入（¥ 格式，保留 2 位小数）、交易笔数、统计周期标签。
  - 收入趋势图：
    - 类型：ECharts LineChart（线图）。
    - X 轴：日期（MM/DD 格式）。
    - Y 轴：金额（¥ 格式）。
    - 数据来源：chartData 数组。
    - 若 chartData 为空显示"暂无数据"。
    - 标题根据角色显示"总收入趋势"（admin）或"我的收入趋势"（caregiver）。
  - 前端 API 调用：getIncomeStatistics(period)。
  - 生命周期：onMounted 调用 load()；周期选择变化时重新调用 load()。
  - 金额格式化：Number(amount).toFixed(2)。

## 5. 角色与权限矩阵

| 操作 | Admin | Caregiver | Resident |
|------|-------|-----------|----------|
| 查看总收入统计 | ✓（全局） | ✗ | ✗ |
| 查看个人收入统计 | ✗ | ✓（自己的） | ✗ |
| 查看统计图表 | ✓ | ✓ | ✗ |

## 6. 答辩常见问答（含实现思路）
- 问：Admin 和 Caregiver 的收入统计有什么区别？
  - 答：Admin 查看全局所有已支付费用的聚合；Caregiver 查看自己护工身份相关的已支付费用（通过 caregiver.user_id 与 appointments.provider_id 关联）。两者使用同一个接口但通过权限判断与条件过滤区分。
  
- 问：如何防止护工查看到其他护工的收入？
  - 答：IncomeController 中对 caregiver 角色先获取本人 caregiver 记录（QueryWrapper.eq("user_id", userId)），再用此 caregiver.userId 和 caregiver.id（兼容新旧字段）过滤 appointments，最后统计这些预约的费用；其他护工即使直接调用接口也只能看到自己的数据。
  
- 问：为什么图表数据要按日期逐日填充？
  - 答：从 startDate 逐日迭代到今日，对无费用的日期设置 amount=0，保证 X 轴日期连续且曲线完整（避免出现缺失日期导致图表跳跃）。
  
- 问：不同周期（today/week/month/year）的日期计算怎么实现？
  - 答：在 getStartDate() 方法中按 period 值分别返回：today 返回当日、week 返回 7 天前、month 返回本月 1 日、year 返回本年 1 月 1 日；endDateTime 固定为 LocalDateTime.now()。
  
- 问：护工没有预约或费用时如何处理？
  - 答：返回 createEmptyStatistics(period)，即 totalAmount=0, totalCount=0, chartData=[]；前端图表识别 chartData.length===0 时显示"暂无数据"。
  
- 问：前端如何从响应中提取并展示数据？
  - 答：调用 getIncomeStatistics(period) 后返回的数据是 { totalAmount, totalCount, chartData, ... }，赋值给 statistics ref；chartData 数组直接用于 ECharts 配置，x 轴用 date 字段，y 轴用 amount 字段。
  
- 问：金额格式化如何实现（显示 ¥200.00）？
  - 答：前端定义 formatAmount(amount) 函数，通过 Number(amount).toFixed(2) 保留 2 位小数，再用模板 ¥{{ formatAmount(value) }} 展示；图表 tooltip 与卡片都需调用此函数。
  
- 问：如何支持更灵活的日期筛选（如自定义日期范围）？
  - 答：后端增加 startDate/endDate 参数覆盖 period 逻辑；前端增加日期选择器（el-date-picker 类型 daterange），选择后调用 getIncomeStatistics({ startDate, endDate })；QueryWrapper 改为 .between("payment_time", startDateTime, endDateTime)。

## 7. 改进建议（答辩加分点）
- 权限精细化：在网关或 AOP 增加角色权限校验，非 admin/caregiver 返回 403。
- 数据缓存：日结数据可短时缓存（如 1 小时内同一 period 请求命中缓存），减少数据库查询。
- 多维度统计：支持按服务类型、按居民、按护工维度分别统计；支持同比环比分析（本月 vs 上月）。
- 图表交互增强：支持自定义日期范围、柱状图与折线图切换、数据导出（CSV/Excel）。
- 预期收入预测：基于历史数据与当前待支付费用，推算本月预期收入；提醒未支付费用即将逾期。
- 税务与合规：增加税率计算、发票生成、对账单导出等财务功能；记录修改日志与操作审计。
- 异常处理：对空数据、极值数据进行合理回退与提示；护工无权访问时明确提示"无权查看此数据"而非返回空列表。
